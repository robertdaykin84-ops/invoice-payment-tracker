{% extends "base.html" %}

{% block title %}New Client Enquiry{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('new_onboarding') }}">New Client or Fund</a></li>
                <li class="breadcrumb-item active">New Enquiry</li>
            </ol>
        </nav>
        <h1 class="h3 mb-1">New Client Enquiry</h1>
        <p class="text-muted">Complete this form to submit a new client enquiry</p>
    </div>
</div>

<!-- Wizard Stepper -->
<ul class="wizard-stepper mb-4">
    {% for p in phases %}
    <li class="wizard-step {% if p.num < phase %}completed{% elif p.num == phase %}current{% endif %}">
        <div class="step-icon">
            {% if p.num < phase %}
            <i class="bi bi-check"></i>
            {% else %}
            <i class="bi {{ p.icon }}"></i>
            {% endif %}
        </div>
        <span class="step-label">{{ p.name }}</span>
    </li>
    {% endfor %}
</ul>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clipboard-check me-2"></i>
                Client Enquiry Form
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('onboarding_phase', onboarding_id=onboarding_id, phase=1) }}">
                    <!-- Section 1: Sponsor Entity Details -->
                    <h6 class="text-uppercase text-muted small mb-3">Sponsor Entity Details</h6>

                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <label class="form-label">Legal Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="legal_name" required
                                   placeholder="e.g., Granite Capital Partners LLP"
                                   value="{{ enquiry.legal_name if enquiry else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Trading Name</label>
                            <input type="text" class="form-control" name="trading_name"
                                   placeholder="If different from legal name"
                                   value="{{ enquiry.trading_name if enquiry else '' }}">
                        </div>
                    </div>

                    <!-- Entity Type Radio Button Cards -->
                    <div class="mb-4">
                        <label class="form-label">Entity Type <span class="text-danger">*</span></label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <input type="radio" class="btn-check" name="entity_type" id="type_company" value="company" {% if enquiry and enquiry.entity_type == 'company' %}checked{% elif not enquiry %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100 text-start p-3" for="type_company">
                                    <i class="bi bi-building me-2"></i>
                                    <strong>Company</strong>
                                    <small class="d-block text-muted">Ltd, Inc, PLC</small>
                                </label>
                            </div>
                            <div class="col-md-4">
                                <input type="radio" class="btn-check" name="entity_type" id="type_llp" value="llp" {% if enquiry and enquiry.entity_type == 'llp' %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100 text-start p-3" for="type_llp">
                                    <i class="bi bi-people me-2"></i>
                                    <strong>LLP</strong>
                                    <small class="d-block text-muted">Limited Liability Partnership</small>
                                </label>
                            </div>
                            <div class="col-md-4">
                                <input type="radio" class="btn-check" name="entity_type" id="type_lp" value="lp" {% if enquiry and enquiry.entity_type == 'lp' %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100 text-start p-3" for="type_lp">
                                    <i class="bi bi-diagram-3 me-2"></i>
                                    <strong>LP</strong>
                                    <small class="d-block text-muted">Limited Partnership</small>
                                </label>
                            </div>
                            <div class="col-md-4">
                                <input type="radio" class="btn-check" name="entity_type" id="type_trust" value="trust" {% if enquiry and enquiry.entity_type == 'trust' %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100 text-start p-3" for="type_trust">
                                    <i class="bi bi-shield-check me-2"></i>
                                    <strong>Trust</strong>
                                    <small class="d-block text-muted">Trust structure</small>
                                </label>
                            </div>
                            <div class="col-md-4">
                                <input type="radio" class="btn-check" name="entity_type" id="type_foundation" value="foundation" {% if enquiry and enquiry.entity_type == 'foundation' %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100 text-start p-3" for="type_foundation">
                                    <i class="bi bi-bank me-2"></i>
                                    <strong>Foundation</strong>
                                    <small class="d-block text-muted">Foundation entity</small>
                                </label>
                            </div>
                            <div class="col-md-4">
                                <input type="radio" class="btn-check" name="entity_type" id="type_other" value="other" {% if enquiry and enquiry.entity_type == 'other' %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100 text-start p-3" for="type_other">
                                    <i class="bi bi-three-dots me-2"></i>
                                    <strong>Other</strong>
                                    <small class="d-block text-muted">Other entity type</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label">Jurisdiction <span class="text-danger">*</span></label>
                            <select class="form-select" name="jurisdiction" required>
                                <option value="">Select jurisdiction...</option>
                                <option value="UK" {% if enquiry and enquiry.jurisdiction == 'UK' %}selected{% endif %}>United Kingdom</option>
                                <option value="Jersey" {% if enquiry and enquiry.jurisdiction == 'Jersey' %}selected{% endif %}>Jersey</option>
                                <option value="Guernsey" {% if enquiry and enquiry.jurisdiction == 'Guernsey' %}selected{% endif %}>Guernsey</option>
                                <option value="Cayman" {% if enquiry and enquiry.jurisdiction == 'Cayman' %}selected{% endif %}>Cayman Islands</option>
                                <option value="Luxembourg" {% if enquiry and enquiry.jurisdiction == 'Luxembourg' %}selected{% endif %}>Luxembourg</option>
                                <option value="Ireland" {% if enquiry and enquiry.jurisdiction == 'Ireland' %}selected{% endif %}>Ireland</option>
                                <option value="US-Delaware" {% if enquiry and enquiry.jurisdiction == 'US-Delaware' %}selected{% endif %}>United States (Delaware)</option>
                                <option value="Other" {% if enquiry and enquiry.jurisdiction == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Registration Number <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="registration_number" required
                                   placeholder="e.g., OC123456"
                                   value="{{ enquiry.registration_number if enquiry else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Date of Incorporation <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="date_of_incorporation" required
                                   value="{{ enquiry.date_of_incorporation if enquiry else '' }}">
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Registered Address <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="registered_address" rows="2" required
                                      placeholder="Full registered address...">{{ enquiry.registered_address if enquiry else '' }}</textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Principal Place of Business</label>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="sameAsRegistered" name="same_as_registered">
                                <label class="form-check-label small" for="sameAsRegistered">
                                    Same as registered address
                                </label>
                            </div>
                            <textarea class="form-control" name="principal_place_of_business" rows="2" id="principalPlaceOfBusiness"
                                      placeholder="Principal place of business...">{{ enquiry.principal_place_of_business if enquiry else '' }}</textarea>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Section 2: Regulatory Status -->
                    <h6 class="text-uppercase text-muted small mb-3">Regulatory Status</h6>

                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label">Regulatory Status <span class="text-danger">*</span></label>
                            <select class="form-select" name="regulatory_status" id="regulatoryStatus" required>
                                <option value="">Select status...</option>
                                <option value="regulated" {% if enquiry and enquiry.regulatory_status == 'regulated' %}selected{% endif %}>Regulated</option>
                                <option value="not_regulated" {% if enquiry and enquiry.regulatory_status == 'not_regulated' %}selected{% endif %}>Not Regulated</option>
                                <option value="exempt" {% if enquiry and enquiry.regulatory_status == 'exempt' %}selected{% endif %}>Exempt</option>
                                <option value="pending_registration" {% if enquiry and enquiry.regulatory_status == 'pending_registration' %}selected{% endif %}>Pending Registration</option>
                            </select>
                        </div>
                        <div id="regulated-fields" style="display: none;" class="col-md-8">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Regulator <span class="text-danger">*</span></label>
                                    <select class="form-select" name="regulator" id="regulator">
                                        <option value="">Select regulator...</option>
                                        <option value="FCA" {% if enquiry and enquiry.regulator == 'FCA' %}selected{% endif %}>FCA</option>
                                        <option value="JFSC" {% if enquiry and enquiry.regulator == 'JFSC' %}selected{% endif %}>JFSC</option>
                                        <option value="GFSC" {% if enquiry and enquiry.regulator == 'GFSC' %}selected{% endif %}>GFSC</option>
                                        <option value="CIMA" {% if enquiry and enquiry.regulator == 'CIMA' %}selected{% endif %}>CIMA</option>
                                        <option value="SEC" {% if enquiry and enquiry.regulator == 'SEC' %}selected{% endif %}>SEC</option>
                                        <option value="CSSF" {% if enquiry and enquiry.regulator == 'CSSF' %}selected{% endif %}>CSSF</option>
                                        <option value="CBI" {% if enquiry and enquiry.regulator == 'CBI' %}selected{% endif %}>CBI</option>
                                        <option value="Other" {% if enquiry and enquiry.regulator == 'Other' %}selected{% endif %}>Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">License/Registration Number <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="license_number" id="licenseNumber"
                                           placeholder="e.g., FRN 123456"
                                           value="{{ enquiry.license_number if enquiry else '' }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Section 3: Source of Wealth -->
                    <h6 class="text-uppercase text-muted small mb-3">Source of Wealth</h6>

                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label">Principal Business Activities <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="principal_business_activities" rows="2" required
                                      placeholder="Describe the sponsor's primary business activities and revenue sources...">{{ enquiry.principal_business_activities if enquiry else '' }}</textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Source of Wealth Narrative <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="source_of_wealth_narrative" rows="3" required
                                      placeholder="Describe how the sponsor accumulated its wealth/capital...">{{ enquiry.source_of_wealth_narrative if enquiry else '' }}</textarea>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-lg me-1"></i> Cancel
                        </a>
                        <div>
                            <button type="submit" name="action" value="save" class="btn btn-outline-primary me-2">
                                <i class="bi bi-save me-1"></i> Save Draft
                            </button>
                            <button type="submit" name="action" value="next" class="btn btn-primary">
                                Continue <i class="bi bi-arrow-right ms-1"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Phase Info -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>
                Enquiry Guidance
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">
                    This form captures the essential information about the sponsor entity to begin the client onboarding process.
                </p>
                <h6 class="small fw-bold">Required Information:</h6>
                <ul class="small text-muted mb-0">
                    <li>Legal name and entity type</li>
                    <li>Jurisdiction of incorporation</li>
                    <li>Registration details</li>
                    <li>Registered address</li>
                </ul>
            </div>
        </div>

        <!-- AI Assistance -->
        <div class="card border-primary">
            <div class="card-header bg-primary bg-opacity-10 text-primary">
                <i class="bi bi-robot me-2"></i>
                AI Assistance
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">
                    AI features available in this phase:
                </p>
                <ul class="list-unstyled small mb-0">
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success me-1"></i>
                        Jurisdiction risk screening
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success me-1"></i>
                        Conflict check against existing clients
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success me-1"></i>
                        Regulatory status lookup
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sameAsRegisteredCheckbox = document.getElementById('sameAsRegistered');
    const principalPlaceOfBusiness = document.getElementById('principalPlaceOfBusiness');
    const registeredAddress = document.querySelector('textarea[name="registered_address"]');

    if (sameAsRegisteredCheckbox && principalPlaceOfBusiness && registeredAddress) {
        sameAsRegisteredCheckbox.addEventListener('change', function() {
            if (this.checked) {
                principalPlaceOfBusiness.value = registeredAddress.value;
                principalPlaceOfBusiness.disabled = true;
            } else {
                principalPlaceOfBusiness.disabled = false;
            }
        });

        registeredAddress.addEventListener('input', function() {
            if (sameAsRegisteredCheckbox.checked) {
                principalPlaceOfBusiness.value = this.value;
            }
        });
    }

    // Regulatory Status conditional fields
    const regulatoryStatusSelect = document.getElementById('regulatoryStatus');
    const regulatedFields = document.getElementById('regulated-fields');
    const regulatorSelect = document.getElementById('regulator');
    const licenseNumberInput = document.getElementById('licenseNumber');

    function toggleRegulatedFields() {
        if (regulatoryStatusSelect.value === 'regulated') {
            regulatedFields.style.display = '';
            regulatorSelect.required = true;
            licenseNumberInput.required = true;
        } else {
            regulatedFields.style.display = 'none';
            regulatorSelect.required = false;
            licenseNumberInput.required = false;
            regulatorSelect.value = '';
            licenseNumberInput.value = '';
        }
    }

    if (regulatoryStatusSelect && regulatedFields) {
        regulatoryStatusSelect.addEventListener('change', toggleRegulatedFields);
        // Initialize on page load
        toggleRegulatedFields();
    }
});
</script>
{% endblock %}
