{% extends "base.html" %}

{% block title %}New Client Enquiry{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('new_onboarding') }}">New Client or Fund</a></li>
                <li class="breadcrumb-item active">New Enquiry</li>
            </ol>
        </nav>
        <h1 class="h3 mb-1">New Client Enquiry</h1>
        <p class="text-muted">Complete this form to submit a new client enquiry</p>
    </div>
</div>

<!-- Wizard Stepper -->
<ul class="wizard-stepper mb-4">
    {% for p in phases %}
    <li class="wizard-step {% if p.num < phase %}completed{% elif p.num == phase %}current{% endif %}">
        <div class="step-icon">
            {% if p.num < phase %}
            <i class="bi bi-check"></i>
            {% else %}
            <i class="bi {{ p.icon }}"></i>
            {% endif %}
        </div>
        <span class="step-label">{{ p.name }}</span>
    </li>
    {% endfor %}
</ul>

<div class="row">
    <div class="col-lg-8">
        <form id="enquiryForm" method="POST" action="{{ url_for('onboarding_phase', onboarding_id=onboarding_id, phase=1) }}" enctype="multipart/form-data"
              data-loading-message="Saving Enquiry..." data-loading-submessage="Saving sponsor and fund details">

            <!-- ============================================================ -->
            <!-- PART A: SPONSOR DETAILS -->
            <!-- ============================================================ -->
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-building me-2"></i>
                    <strong>PART A: SPONSOR DETAILS</strong>
                </div>
            </div>

            <!-- Section 1: Sponsor Entity Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-info-circle me-2"></i>
                    1. Entity Information
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-8">
                            <label class="form-label">Legal Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="legal_name" required
                                   placeholder="e.g., Granite Capital Partners LLP"
                                   value="{{ enquiry.sponsor_name if enquiry else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Trading Name</label>
                            <input type="text" class="form-control" name="trading_name"
                                   placeholder="If different from legal name"
                                   value="{{ enquiry.trading_name if enquiry else '' }}">
                        </div>
                    </div>

                    <!-- Entity Type Radio Button Cards -->
                    <div class="mb-3">
                        <label class="form-label">Entity Type <span class="text-danger">*</span></label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <input type="radio" class="btn-check" name="entity_type" id="type_company" value="company" {% if enquiry and enquiry.entity_type == 'company' %}checked{% elif not enquiry %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100 text-start p-3" for="type_company">
                                    <i class="bi bi-building me-2"></i>
                                    <strong>Company</strong>
                                    <small class="d-block text-muted">Ltd, Inc, PLC</small>
                                </label>
                            </div>
                            <div class="col-md-4">
                                <input type="radio" class="btn-check" name="entity_type" id="type_llp" value="llp" {% if enquiry and enquiry.entity_type == 'llp' %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100 text-start p-3" for="type_llp">
                                    <i class="bi bi-people me-2"></i>
                                    <strong>LLP</strong>
                                    <small class="d-block text-muted">Limited Liability Partnership</small>
                                </label>
                            </div>
                            <div class="col-md-4">
                                <input type="radio" class="btn-check" name="entity_type" id="type_lp" value="lp" {% if enquiry and enquiry.entity_type == 'lp' %}checked{% endif %}>
                                <label class="btn btn-outline-primary w-100 text-start p-3" for="type_lp">
                                    <i class="bi bi-diagram-3 me-2"></i>
                                    <strong>LP</strong>
                                    <small class="d-block text-muted">Limited Partnership</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Jurisdiction <span class="text-danger">*</span></label>
                            <select class="form-select" name="jurisdiction" required>
                                <option value="">Select jurisdiction...</option>
                                <option value="UK" {% if enquiry and enquiry.jurisdiction == 'UK' %}selected{% endif %}>United Kingdom</option>
                                <option value="Jersey" {% if enquiry and enquiry.jurisdiction == 'Jersey' %}selected{% endif %}>Jersey</option>
                                <option value="Guernsey" {% if enquiry and enquiry.jurisdiction == 'Guernsey' %}selected{% endif %}>Guernsey</option>
                                <option value="Cayman" {% if enquiry and enquiry.jurisdiction == 'Cayman' %}selected{% endif %}>Cayman Islands</option>
                                <option value="Luxembourg" {% if enquiry and enquiry.jurisdiction == 'Luxembourg' %}selected{% endif %}>Luxembourg</option>
                                <option value="Ireland" {% if enquiry and enquiry.jurisdiction == 'Ireland' %}selected{% endif %}>Ireland</option>
                                <option value="US-Delaware" {% if enquiry and enquiry.jurisdiction == 'US-Delaware' %}selected{% endif %}>United States (Delaware)</option>
                                <option value="Other" {% if enquiry and enquiry.jurisdiction == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Registration Number <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="registration_number" required
                                   placeholder="e.g., OC123456"
                                   value="{{ enquiry.registration_number if enquiry else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Date of Incorporation <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="date_of_incorporation" required
                                   value="{{ enquiry.date_of_incorporation if enquiry else '' }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Addresses -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-geo-alt me-2"></i>
                    2. Addresses
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Registered Address <span class="text-danger">*</span></label>
                            <div class="form-check mb-2" style="visibility: hidden; height: 24px;">
                                <input class="form-check-input" type="checkbox" disabled>
                                <label class="form-check-label small">Placeholder</label>
                            </div>
                            <textarea class="form-control" name="registered_address" rows="3" required
                                      placeholder="Full registered address including postcode...">{{ enquiry.registered_address if enquiry else '' }}</textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Business Address (if different)</label>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="sameAsRegistered" name="same_as_registered"
                                       {% if enquiry and enquiry.registered_address == enquiry.business_address %}checked{% endif %}>
                                <label class="form-check-label small" for="sameAsRegistered">
                                    Same as registered address
                                </label>
                            </div>
                            <textarea class="form-control" name="business_address" rows="3" id="businessAddress"
                                      placeholder="Principal place of business...">{{ enquiry.business_address if enquiry else '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Regulatory Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-shield-check me-2"></i>
                    3. Regulatory Status
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Regulatory Status <span class="text-danger">*</span></label>
                            <select class="form-select" name="regulatory_status" id="regulatoryStatus" required>
                                <option value="">Select status...</option>
                                <option value="regulated" {% if enquiry and enquiry.get('regulatory_status') == 'regulated' %}selected{% endif %}>Regulated</option>
                                <option value="not_regulated" {% if enquiry and enquiry.get('regulatory_status') == 'not_regulated' %}selected{% endif %}>Not Regulated</option>
                                <option value="exempt" {% if enquiry and enquiry.get('regulatory_status') == 'exempt' %}selected{% endif %}>Exempt</option>
                                <option value="pending_registration" {% if enquiry and enquiry.get('regulatory_status') == 'pending_registration' %}selected{% endif %}>Pending Registration</option>
                            </select>
                        </div>
                        <div id="regulated-fields" {% if not enquiry or enquiry.get('regulatory_status') != 'regulated' %}style="display: none;"{% endif %} class="col-md-8">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Regulator <span class="text-danger">*</span></label>
                                    <select class="form-select" name="regulator" id="regulator" {% if enquiry and enquiry.get('regulatory_status') == 'regulated' %}required{% endif %}>
                                        <option value="">Select regulator...</option>
                                        <option value="FCA" {% if enquiry and enquiry.get('regulator') == 'FCA' %}selected{% endif %}>FCA</option>
                                        <option value="JFSC" {% if enquiry and enquiry.get('regulator') == 'JFSC' %}selected{% endif %}>JFSC</option>
                                        <option value="GFSC" {% if enquiry and enquiry.get('regulator') == 'GFSC' %}selected{% endif %}>GFSC</option>
                                        <option value="CIMA" {% if enquiry and enquiry.get('regulator') == 'CIMA' %}selected{% endif %}>CIMA</option>
                                        <option value="SEC" {% if enquiry and enquiry.get('regulator') == 'SEC' %}selected{% endif %}>SEC</option>
                                        <option value="CSSF" {% if enquiry and enquiry.get('regulator') == 'CSSF' %}selected{% endif %}>CSSF</option>
                                        <option value="CBI" {% if enquiry and enquiry.get('regulator') == 'CBI' %}selected{% endif %}>CBI</option>
                                        <option value="Other" {% if enquiry and enquiry.get('regulator') == 'Other' %}selected{% endif %}>Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">License/Registration Number <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="license_number" id="licenseNumber"
                                           placeholder="e.g., FRN 123456"
                                           value="{{ enquiry.get('license_number', '') if enquiry else '' }}"
                                           {% if enquiry and enquiry.get('regulatory_status') == 'regulated' %}required{% endif %}>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Source of Wealth & Source of Funds -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-cash-stack me-2"></i>
                    4. Source of Wealth & Funds
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Principal Business Activities <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="principal_business_activities" rows="2" required
                                      placeholder="Describe the sponsor's primary business activities...">{{ enquiry.business_activities if enquiry else '' }}</textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Source of Wealth <span class="text-danger">*</span></label>
                            <small class="text-muted d-block mb-1">How did the sponsor accumulate its wealth/capital?</small>
                            <textarea class="form-control" name="source_of_wealth" rows="3" required
                                      placeholder="e.g., Management fees from previous funds, carried interest from exits, founder capital...">{{ enquiry.source_of_wealth if enquiry else '' }}</textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Source of Funds <span class="text-danger">*</span></label>
                            <small class="text-muted d-block mb-1">Where will the funds for investment activities come from?</small>
                            <textarea class="form-control" name="source_of_funds" rows="3" required
                                      placeholder="e.g., Institutional investors, pension funds, HNW individuals, family offices...">{{ enquiry.source_of_funds if enquiry else '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Sponsor Directors & UBOs -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-people me-2"></i>5. Sponsor Directors & UBOs</span>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#sponsorPrincipalModal">
                        <i class="bi bi-plus-lg me-1"></i>Add Person
                    </button>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">
                        Add all directors of the sponsor entity and ultimate beneficial owners (UBOs) with 25%+ ownership.
                    </p>
                    <div class="table-responsive">
                        <table class="table table-sm" id="sponsorPrincipalsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>DOB</th>
                                    <th>Address</th>
                                    <th>Role</th>
                                    <th>Ownership %</th>
                                    <th>UBO</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sponsorPrincipalsTableBody">
                                <tr id="noSponsorPrincipalsRow">
                                    <td colspan="7" class="text-center text-muted py-3">
                                        No directors/UBOs added yet. Click "Add Person" to begin.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info small mb-0 mt-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>UBO Threshold:</strong> Any individual with 25% or more ownership is automatically flagged as a UBO.
                    </div>
                </div>
            </div>

            <!-- Hidden input to store sponsor principals JSON for form submission -->
            <input type="hidden" name="sponsor_principals_json" id="sponsorPrincipalsJson" value="[]">

            <!-- ============================================================ -->
            <!-- PART B: FUND DETAILS -->
            <!-- ============================================================ -->
            <div class="card mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-diagram-3 me-2"></i>
                    <strong>PART B: FUND DETAILS</strong>
                </div>
            </div>

            <!-- Section 6: Proposed Fund Structure -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-diagram-3 me-2"></i>
                    6. Fund Structure
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Fund Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="fund_name" required
                                   placeholder="e.g., Granite Capital Fund III LP"
                                   value="{{ enquiry.fund_name if enquiry else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fund Type <span class="text-danger">*</span></label>
                            <select class="form-select" name="fund_type" required>
                                <option value="">Select type...</option>
                                <option value="jpf" {% if enquiry and enquiry.fund_type == 'jpf' %}selected{% endif %}>Jersey Private Fund (JPF)</option>
                                <option value="expert" {% if enquiry and enquiry.fund_type == 'expert' %}selected{% endif %}>Expert Fund</option>
                                <option value="listed" {% if enquiry and enquiry.fund_type == 'listed' %}selected{% endif %}>Listed Fund</option>
                                <option value="other" {% if enquiry and enquiry.fund_type == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Legal Structure <span class="text-danger">*</span></label>
                            <select class="form-select" name="fund_legal_structure" required>
                                <option value="">Select structure...</option>
                                <option value="lp" {% if enquiry and enquiry.legal_structure == 'lp' %}selected{% endif %}>Limited Partnership</option>
                                <option value="unit_trust" {% if enquiry and enquiry.legal_structure == 'unit_trust' %}selected{% endif %}>Unit Trust</option>
                                <option value="icc" {% if enquiry and enquiry.legal_structure == 'icc' %}selected{% endif %}>ICC</option>
                                <option value="pcc" {% if enquiry and enquiry.legal_structure == 'pcc' %}selected{% endif %}>PCC</option>
                                <option value="other" {% if enquiry and enquiry.legal_structure == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Target Fund Size <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="text" class="form-control" name="target_fund_size" required
                                       placeholder="e.g., 500,000,000"
                                       value="{{ enquiry.target_size if enquiry else '' }}">
                            </div>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Investment Strategy <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="investment_strategy" rows="2" required
                                      placeholder="Brief description of investment focus and strategy...">{{ enquiry.investment_strategy if enquiry else '' }}</textarea>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label">Target Investment Countries/Regions <span class="text-danger">*</span></label>
                            <p class="small text-muted mb-2">Select all countries or regions where the fund intends to make investments.</p>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input target-country" type="checkbox" name="target_countries" value="uk" id="countryUK"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'uk' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryUK">United Kingdom</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input target-country" type="checkbox" name="target_countries" value="eu" id="countryEU"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'eu' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryEU">European Union</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input target-country" type="checkbox" name="target_countries" value="us" id="countryUS"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'us' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryUS">United States</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input target-country" type="checkbox" name="target_countries" value="canada" id="countryCanada"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'canada' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryCanada">Canada</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input target-country" type="checkbox" name="target_countries" value="asia_pacific" id="countryAsiaPacific"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'asia_pacific' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryAsiaPacific">Asia Pacific</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input target-country" type="checkbox" name="target_countries" value="middle_east" id="countryMiddleEast"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'middle_east' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryMiddleEast">Middle East</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input target-country" type="checkbox" name="target_countries" value="africa" id="countryAfrica"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'africa' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryAfrica">Africa</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input target-country" type="checkbox" name="target_countries" value="latin_america" id="countryLatinAmerica"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'latin_america' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryLatinAmerica">Latin America</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input target-country high-risk-country" type="checkbox" name="target_countries" value="russia" id="countryRussia"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'russia' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryRussia"><span class="text-danger">Russia</span> <small class="text-danger">(High Risk)</small></label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input target-country high-risk-country" type="checkbox" name="target_countries" value="china" id="countryChina"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'china' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryChina"><span class="text-danger">China</span> <small class="text-danger">(High Risk)</small></label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input target-country high-risk-country" type="checkbox" name="target_countries" value="iran" id="countryIran"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'iran' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryIran"><span class="text-danger">Iran</span> <small class="text-danger">(High Risk)</small></label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input target-country high-risk-country" type="checkbox" name="target_countries" value="north_korea" id="countryNorthKorea"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'north_korea' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryNorthKorea"><span class="text-danger">North Korea</span> <small class="text-danger">(High Risk)</small></label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input target-country" type="checkbox" name="target_countries" value="global" id="countryGlobal"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'global' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryGlobal">Global (All Regions)</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input target-country" type="checkbox" name="target_countries" value="other" id="countryOther"
                                               {{ 'checked' if enquiry and enquiry.target_countries and 'other' in enquiry.target_countries }}>
                                        <label class="form-check-label" for="countryOther">Other (specify below)</label>
                                    </div>
                                    <div class="mt-2" id="otherCountriesField" style="display: none;">
                                        <input type="text" class="form-control form-control-sm" name="other_target_countries" id="otherTargetCountries"
                                               placeholder="Specify other countries..."
                                               value="{{ enquiry.other_target_countries if enquiry else '' }}">
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="target_countries_json" id="targetCountriesJson" value="[]">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 7: Fund GP Directors -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-person-badge me-2"></i>7. Fund GP Directors</span>
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#gpDirectorModal">
                        <i class="bi bi-plus-lg me-1"></i>Add GP Director
                    </button>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">
                        Add all proposed directors of the Fund's General Partner (GP) entity.
                    </p>
                    <div class="table-responsive">
                        <table class="table table-sm" id="gpDirectorsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>DOB</th>
                                    <th>Address</th>
                                    <th>Nationality</th>
                                    <th>Position</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="gpDirectorsTableBody">
                                <tr id="noGpDirectorsRow">
                                    <td colspan="6" class="text-center text-muted py-3">
                                        No GP directors added yet. Click "Add GP Director" to begin.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Hidden input to store GP directors JSON for form submission -->
            <input type="hidden" name="gp_directors_json" id="gpDirectorsJson" value="[]">

            <!-- Section 8: Initial Investors -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>
                        <i class="bi bi-wallet2 me-2"></i>8. Initial/Seed Investors
                        <span id="investorCommitmentBadge" class="badge bg-secondary ms-2">No investors</span>
                    </span>
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#investorModal">
                        <i class="bi bi-plus-lg me-1"></i>Add Investor
                    </button>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">
                        Add known or expected initial investors and their anticipated commitment percentages. <strong>Total must equal 100%.</strong>
                    </p>
                    <div class="table-responsive">
                        <table class="table table-sm" id="investorsTable">
                            <thead>
                                <tr>
                                    <th>Investor Name</th>
                                    <th>Type</th>
                                    <th>Jurisdiction</th>
                                    <th>Commitment %</th>
                                    <th>Commitment Amount</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="investorsTableBody">
                                <tr id="noInvestorsRow">
                                    <td colspan="6" class="text-center text-muted py-3">
                                        No investors added yet. Click "Add Investor" to begin.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Hidden input to store investors JSON for form submission -->
            <input type="hidden" name="investors_json" id="investorsJson" value="[]">

            <!-- ============================================================ -->
            <!-- PART C: CONTACT & DECLARATION -->
            <!-- ============================================================ -->
            <div class="card mb-4 border-secondary">
                <div class="card-header bg-secondary text-white">
                    <i class="bi bi-person-lines-fill me-2"></i>
                    <strong>PART C: CONTACT & DECLARATION</strong>
                </div>
            </div>

            <!-- Section 9: Primary Contact -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-person-lines-fill me-2"></i>
                    9. Primary Contact
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Contact Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="contact_name" required
                                   placeholder="Primary point of contact"
                                   value="{{ enquiry.contact_name if enquiry else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" name="contact_email" required
                                   placeholder="email@example.com"
                                   value="{{ enquiry.contact_email if enquiry else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" name="contact_phone"
                                   placeholder="+44 20 1234 5678"
                                   value="{{ enquiry.contact_phone if enquiry else '' }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 10: Referral Source -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-megaphone me-2"></i>
                    10. Referral Source
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">How did you hear about us?</label>
                            <select class="form-select" name="enquiry_source" id="enquirySource">
                                <option value="">Select source...</option>
                                <option value="referral" {% if enquiry and enquiry.enquiry_source == 'referral' %}selected{% endif %}>Referral</option>
                                <option value="existing" {% if enquiry and enquiry.enquiry_source == 'existing' %}selected{% endif %}>Existing Client</option>
                                <option value="website" {% if enquiry and enquiry.enquiry_source == 'website' %}selected{% endif %}>Website</option>
                                <option value="event" {% if enquiry and enquiry.enquiry_source == 'event' %}selected{% endif %}>Industry Event</option>
                                <option value="other" {% if enquiry and enquiry.enquiry_source == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-8" id="referrerNameField" style="display: none;">
                            <label class="form-label">Referrer Name/Details <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="referrer_name" id="referrerName"
                                   placeholder="Name of the referrer or event details"
                                   value="{{ enquiry.referrer_name if enquiry else '' }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 11: Declaration -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-check2-square me-2"></i>
                    11. Declaration
                </div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="declaration" name="declaration" required
       {% if enquiry and enquiry.declaration_accepted %}checked{% endif %}>
                        <label class="form-check-label" for="declaration">
                            I confirm that the information provided is accurate and complete to the best of my knowledge.
                            I understand that this information will be used for due diligence and regulatory compliance purposes.
                            <span class="text-danger">*</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-between mb-4">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg me-1"></i> Cancel
                </a>
                <div>
                    <button type="submit" name="action" value="save" class="btn btn-outline-primary me-2">
                        <i class="bi bi-save me-1"></i> Save Draft
                    </button>
                    <button type="submit" name="action" value="next" class="btn btn-primary">
                        Continue <i class="bi bi-arrow-right ms-1"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Phase Info -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>
                Enquiry Guidance
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">
                    This form captures comprehensive information about the sponsor and proposed fund.
                </p>
                <h6 class="small fw-bold">Part A - Sponsor:</h6>
                <ul class="small text-muted mb-2">
                    <li>Legal name and entity details</li>
                    <li>Registered & business addresses</li>
                    <li>Source of Wealth & Funds</li>
                    <li>Directors and UBOs (25%+ owners)</li>
                </ul>
                <h6 class="small fw-bold">Part B - Fund:</h6>
                <ul class="small text-muted mb-0">
                    <li>Fund structure and strategy</li>
                    <li>GP Directors</li>
                    <li>Initial investors</li>
                </ul>
            </div>
        </div>

        <!-- AI Assistance -->
        <div class="card border-primary">
            <div class="card-header bg-primary bg-opacity-10 text-primary">
                <i class="bi bi-robot me-2"></i>
                AI Assistance
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">
                    AI features available in this phase:
                </p>
                <ul class="list-unstyled small mb-0">
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success me-1"></i>
                        Jurisdiction risk screening
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success me-1"></i>
                        Conflict check against existing clients
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check-circle text-success me-1"></i>
                        Regulatory status lookup
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Sponsor Principal Modal -->
<div class="modal fade" id="sponsorPrincipalModal" tabindex="-1" aria-labelledby="sponsorPrincipalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sponsorPrincipalModalLabel">
                    <i class="bi bi-person-plus me-2"></i>Add Sponsor Director/UBO
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Full Legal Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="sponsorPrincipalFullName" required
                               placeholder="As appears on ID">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Former Names</label>
                        <input type="text" class="form-control" id="sponsorPrincipalFormerNames"
                               placeholder="Maiden name, previous names">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="sponsorPrincipalDob" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Nationality <span class="text-danger">*</span></label>
                        <select class="form-select" id="sponsorPrincipalNationality" required>
                            <option value="">Select nationality...</option>
                            <option value="British">British</option>
                            <option value="American">American</option>
                            <option value="French">French</option>
                            <option value="German">German</option>
                            <option value="Irish">Irish</option>
                            <option value="Norwegian">Norwegian</option>
                            <option value="Swedish">Swedish</option>
                            <option value="Swiss">Swiss</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Country of Residence <span class="text-danger">*</span></label>
                        <select class="form-select" id="sponsorPrincipalResidenceCountry" required>
                            <option value="">Select country...</option>
                            <option value="UK">United Kingdom</option>
                            <option value="USA">United States</option>
                            <option value="France">France</option>
                            <option value="Germany">Germany</option>
                            <option value="Ireland">Ireland</option>
                            <option value="Jersey">Jersey</option>
                            <option value="Guernsey">Guernsey</option>
                            <option value="Norway">Norway</option>
                            <option value="Sweden">Sweden</option>
                            <option value="Switzerland">Switzerland</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Residential Address <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="sponsorPrincipalResidentialAddress" rows="2" required
                                  placeholder="Full residential address including postcode..."></textarea>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Role <span class="text-danger">*</span></label>
                        <select class="form-select" id="sponsorPrincipalRole" required>
                            <option value="">Select role...</option>
                            <option value="controller">Controller</option>
                            <option value="ubo">UBO (Ultimate Beneficial Owner)</option>
                            <option value="both">Both (Controller & UBO)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Ownership %</label>
                        <input type="number" class="form-control" id="sponsorPrincipalOwnership" min="0" max="100" step="0.01"
                               placeholder="0-100">
                        <small class="text-muted">Required for UBO roles</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addSponsorPrincipal()">
                    <i class="bi bi-plus-lg me-1"></i>Add Person
                </button>
            </div>
        </div>
    </div>
</div>

<!-- GP Director Modal -->
<div class="modal fade" id="gpDirectorModal" tabindex="-1" aria-labelledby="gpDirectorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gpDirectorModalLabel">
                    <i class="bi bi-person-badge me-2"></i>Add GP Director
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Full Legal Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="gpDirectorFullName" required
                               placeholder="As appears on ID">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Former Names</label>
                        <input type="text" class="form-control" id="gpDirectorFormerNames"
                               placeholder="Maiden name, previous names">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="gpDirectorDob" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Nationality <span class="text-danger">*</span></label>
                        <select class="form-select" id="gpDirectorNationality" required>
                            <option value="">Select nationality...</option>
                            <option value="British">British</option>
                            <option value="American">American</option>
                            <option value="French">French</option>
                            <option value="German">German</option>
                            <option value="Irish">Irish</option>
                            <option value="Norwegian">Norwegian</option>
                            <option value="Swedish">Swedish</option>
                            <option value="Swiss">Swiss</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Country of Residence <span class="text-danger">*</span></label>
                        <select class="form-select" id="gpDirectorResidenceCountry" required>
                            <option value="">Select country...</option>
                            <option value="UK">United Kingdom</option>
                            <option value="USA">United States</option>
                            <option value="France">France</option>
                            <option value="Germany">Germany</option>
                            <option value="Ireland">Ireland</option>
                            <option value="Jersey">Jersey</option>
                            <option value="Guernsey">Guernsey</option>
                            <option value="Norway">Norway</option>
                            <option value="Sweden">Sweden</option>
                            <option value="Switzerland">Switzerland</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Residential Address <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="gpDirectorResidentialAddress" rows="2" required
                                  placeholder="Full residential address including postcode..."></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Position <span class="text-danger">*</span></label>
                        <select class="form-select" id="gpDirectorPosition" required>
                            <option value="">Select position...</option>
                            <option value="director">Director</option>
                            <option value="chairman">Chairman</option>
                            <option value="independent_director">Independent Director</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="addGpDirector()">
                    <i class="bi bi-plus-lg me-1"></i>Add GP Director
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Investor Modal -->
<div class="modal fade" id="investorModal" tabindex="-1" aria-labelledby="investorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="investorModalLabel">
                    <i class="bi bi-wallet2 me-2"></i>Add Initial Investor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Investor Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="investorName" required
                               placeholder="Name of investor entity or individual">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Investor Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="investorType" required>
                            <option value="">Select type...</option>
                            <option value="institutional">Institutional Investor</option>
                            <option value="pension_fund">Pension Fund</option>
                            <option value="family_office">Family Office</option>
                            <option value="hnw">High Net Worth Individual</option>
                            <option value="fund_of_funds">Fund of Funds</option>
                            <option value="sponsor_affiliate">Sponsor/Affiliate</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Jurisdiction <span class="text-danger">*</span></label>
                        <select class="form-select" id="investorJurisdiction" required>
                            <option value="">Select jurisdiction...</option>
                            <option value="UK">United Kingdom</option>
                            <option value="USA">United States</option>
                            <option value="EU">European Union</option>
                            <option value="Switzerland">Switzerland</option>
                            <option value="Middle East">Middle East</option>
                            <option value="Asia">Asia</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Commitment % <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="investorCommitmentPct" min="0" max="100" step="0.01" required
                               placeholder="Expected % of total fund">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Commitment Amount ($)</label>
                        <input type="text" class="form-control" id="investorCommitmentAmount"
                               placeholder="e.g., 50,000,000">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="addInvestor()">
                    <i class="bi bi-plus-lg me-1"></i>Add Investor
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Same as Registered checkbox
    const sameAsRegisteredCheckbox = document.getElementById('sameAsRegistered');
    const businessAddress = document.getElementById('businessAddress');
    const registeredAddress = document.querySelector('textarea[name="registered_address"]');

    if (sameAsRegisteredCheckbox && businessAddress && registeredAddress) {
        sameAsRegisteredCheckbox.addEventListener('change', function() {
            if (this.checked) {
                businessAddress.value = registeredAddress.value;
                businessAddress.disabled = true;
            } else {
                businessAddress.disabled = false;
            }
        });

        registeredAddress.addEventListener('input', function() {
            if (sameAsRegisteredCheckbox.checked) {
                businessAddress.value = this.value;
            }
        });

        // Initialize on page load
        if (sameAsRegisteredCheckbox.checked) {
            businessAddress.disabled = true;
        }
    }

    // Regulatory Status conditional fields
    const regulatoryStatusSelect = document.getElementById('regulatoryStatus');
    const regulatedFields = document.getElementById('regulated-fields');
    const regulatorSelect = document.getElementById('regulator');
    const licenseNumberInput = document.getElementById('licenseNumber');

    function toggleRegulatedFields() {
        if (regulatoryStatusSelect.value === 'regulated') {
            regulatedFields.style.display = '';
            regulatorSelect.required = true;
            licenseNumberInput.required = true;
        } else {
            regulatedFields.style.display = 'none';
            regulatorSelect.required = false;
            licenseNumberInput.required = false;
        }
    }

    if (regulatoryStatusSelect && regulatedFields) {
        regulatoryStatusSelect.addEventListener('change', toggleRegulatedFields);
        toggleRegulatedFields();
    }

    // Auto-check UBO if ownership >= 25%
    const sponsorOwnershipInput = document.getElementById('sponsorPrincipalOwnership');
    const sponsorUboCheckbox = document.getElementById('sponsorPrincipalIsUbo');

    if (sponsorOwnershipInput && sponsorUboCheckbox) {
        sponsorOwnershipInput.addEventListener('input', function() {
            const ownership = parseFloat(this.value) || 0;
            if (ownership >= 25) {
                sponsorUboCheckbox.checked = true;
            }
        });
    }

    // Enquiry Source conditional referrer field
    const enquirySourceSelect = document.getElementById('enquirySource');
    const referrerNameField = document.getElementById('referrerNameField');
    const referrerNameInput = document.getElementById('referrerName');

    function toggleReferrerField() {
        if (['referral', 'event', 'other'].includes(enquirySourceSelect.value)) {
            referrerNameField.style.display = '';
            referrerNameInput.required = true;
        } else {
            referrerNameField.style.display = 'none';
            referrerNameInput.required = false;
        }
    }

    if (enquirySourceSelect && referrerNameField) {
        enquirySourceSelect.addEventListener('change', toggleReferrerField);
        toggleReferrerField();
    }

    // Load existing principals from enquiry data if available
    {% if enquiry and enquiry.principals %}
    const existingPrincipals = {{ enquiry.principals | tojson | safe }};
    if (existingPrincipals && existingPrincipals.length > 0) {
        existingPrincipals.forEach(function(p) {
            // Map legacy format to new format
            let role = (p.role || 'director').toLowerCase().replace(' ', '_');
            // Map legacy role names to new format
            const roleMappings = {
                'partner': 'both',
                'director_ubo': 'both',
                'controller_ubo': 'both'
            };
            role = roleMappings[role] || role;

            sponsorPrincipals.push({
                full_name: p.name || p.full_name,
                former_names: p.former_names || '',
                dob: p.dob || '',
                nationality: p.nationality || '',
                country_of_residence: p.country_of_residence || '',
                residential_address: p.residential_address || p.address || '',
                role: role,
                ownership_pct: parseFloat(p.ownership || p.ownership_pct || '0'),
                is_ubo: p.is_ubo || (parseFloat(p.ownership || p.ownership_pct || '0') >= 25)
            });
        });
        renderSponsorPrincipalsTable();
        updateSponsorPrincipalsJson();
    }
    {% endif %}

    // Form submission validation
    const enquiryForm = document.getElementById('enquiryForm');
    if (enquiryForm) {
        enquiryForm.addEventListener('submit', function(e) {
            // Validate investor commitment total
            if (typeof investors !== 'undefined' && investors.length > 0) {
                const total = investors.reduce((sum, inv) => sum + (inv.commitment_pct || 0), 0);
                if (Math.abs(total - 100) > 0.01) {
                    e.preventDefault();
                    alert(`Investor commitments must total 100%. Current total: ${total.toFixed(2)}%`);
                    // Scroll to investors section
                    document.getElementById('investorsTable').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return false;
                }
            }
            return true;
        });
    }
});

// ============================================================
// SPONSOR PRINCIPALS MANAGEMENT
// ============================================================
let sponsorPrincipals = [];

function addSponsorPrincipal() {
    const fullName = document.getElementById('sponsorPrincipalFullName').value.trim();
    const formerNames = document.getElementById('sponsorPrincipalFormerNames').value.trim();
    const dob = document.getElementById('sponsorPrincipalDob').value;
    const nationality = document.getElementById('sponsorPrincipalNationality').value;
    const residenceCountry = document.getElementById('sponsorPrincipalResidenceCountry').value;
    const residentialAddress = document.getElementById('sponsorPrincipalResidentialAddress').value.trim();
    const role = document.getElementById('sponsorPrincipalRole').value;
    const ownership = document.getElementById('sponsorPrincipalOwnership').value;

    // Determine if UBO from role selection
    const isUbo = (role === 'ubo' || role === 'both');

    if (!fullName || !dob || !nationality || !residenceCountry || !residentialAddress || !role) {
        alert('Please fill in all required fields.');
        return;
    }

    // Validate ownership percentage for UBO roles
    if (isUbo && (!ownership || parseFloat(ownership) <= 0)) {
        alert('Ownership percentage is required for UBO roles.');
        return;
    }

    sponsorPrincipals.push({
        full_name: fullName,
        former_names: formerNames,
        dob: dob,
        nationality: nationality,
        country_of_residence: residenceCountry,
        residential_address: residentialAddress,
        role: role,
        ownership_pct: ownership ? parseFloat(ownership) : null,
        is_ubo: isUbo,
        entity_type: 'sponsor'
    });

    renderSponsorPrincipalsTable();
    updateSponsorPrincipalsJson();
    clearSponsorPrincipalForm();
    bootstrap.Modal.getInstance(document.getElementById('sponsorPrincipalModal')).hide();
}

function removeSponsorPrincipal(index) {
    if (confirm('Remove this person?')) {
        sponsorPrincipals.splice(index, 1);
        renderSponsorPrincipalsTable();
        updateSponsorPrincipalsJson();
    }
}

function viewSponsorPrincipal(index) {
    const principal = sponsorPrincipals[index];
    alert(`View principal: ${principal.full_name}`);
}

function editSponsorPrincipal(index) {
    const principal = sponsorPrincipals[index];
    alert(`Edit principal: ${principal.full_name}`);
}

function renderSponsorPrincipalsTable() {
    const tbody = document.getElementById('sponsorPrincipalsTableBody');
    tbody.innerHTML = '';

    if (sponsorPrincipals.length === 0) {
        tbody.innerHTML = `
            <tr id="noSponsorPrincipalsRow">
                <td colspan="7" class="text-center text-muted py-3">
                    No directors/UBOs added yet. Click "Add Person" to begin.
                </td>
            </tr>
        `;
        return;
    }

    sponsorPrincipals.forEach((p, index) => {
        const roleLabels = {
            'controller': 'Controller',
            'ubo': 'UBO',
            'both': 'Controller & UBO'
        };
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${escapeHtml(p.full_name)}</strong></td>
            <td><small>${p.dob || '-'}</small></td>
            <td><small>${escapeHtml(p.residential_address.substring(0, 30))}...</small></td>
            <td>${roleLabels[p.role] || p.role}</td>
            <td>${p.ownership_pct !== null ? p.ownership_pct + '%' : '-'}</td>
            <td>${p.is_ubo ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle text-muted"></i>'}</td>
            <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="viewSponsorPrincipal(${index})">
                    <i class="bi bi-eye"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary me-1" onclick="editSponsorPrincipal(${index})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSponsorPrincipal(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateSponsorPrincipalsJson() {
    document.getElementById('sponsorPrincipalsJson').value = JSON.stringify(sponsorPrincipals);
}

function clearSponsorPrincipalForm() {
    document.getElementById('sponsorPrincipalFullName').value = '';
    document.getElementById('sponsorPrincipalFormerNames').value = '';
    document.getElementById('sponsorPrincipalDob').value = '';
    document.getElementById('sponsorPrincipalNationality').value = '';
    document.getElementById('sponsorPrincipalResidenceCountry').value = '';
    document.getElementById('sponsorPrincipalResidentialAddress').value = '';
    document.getElementById('sponsorPrincipalRole').value = '';
    document.getElementById('sponsorPrincipalOwnership').value = '';
}

// ============================================================
// GP DIRECTORS MANAGEMENT
// ============================================================
let gpDirectors = [];

// Auto-populate GP directors from enquiry data if available
{% if enquiry and enquiry.gp_directors %}
const existingGpDirectors = {{ enquiry.gp_directors | tojson | safe }};
if (existingGpDirectors && existingGpDirectors.length > 0) {
    existingGpDirectors.forEach(function(d) {
        gpDirectors.push({
            full_name: d.full_name || d.name,
            former_names: d.former_names || '',
            dob: d.dob || '',
            nationality: d.nationality || '',
            country_of_residence: d.country_of_residence || '',
            residential_address: d.residential_address || d.address || '',
            position: d.position || 'director',
            entity_type: 'gp'
        });
    });
    // Render after DOM is ready
    setTimeout(function() {
        renderGpDirectorsTable();
        updateGpDirectorsJson();
    }, 0);
}
{% endif %}

function addGpDirector() {
    const fullName = document.getElementById('gpDirectorFullName').value.trim();
    const formerNames = document.getElementById('gpDirectorFormerNames').value.trim();
    const dob = document.getElementById('gpDirectorDob').value;
    const nationality = document.getElementById('gpDirectorNationality').value;
    const residenceCountry = document.getElementById('gpDirectorResidenceCountry').value;
    const residentialAddress = document.getElementById('gpDirectorResidentialAddress').value.trim();
    const position = document.getElementById('gpDirectorPosition').value;

    if (!fullName || !dob || !nationality || !residenceCountry || !residentialAddress || !position) {
        alert('Please fill in all required fields.');
        return;
    }

    gpDirectors.push({
        full_name: fullName,
        former_names: formerNames,
        dob: dob,
        nationality: nationality,
        country_of_residence: residenceCountry,
        residential_address: residentialAddress,
        position: position,
        entity_type: 'gp'
    });

    renderGpDirectorsTable();
    updateGpDirectorsJson();
    clearGpDirectorForm();
    bootstrap.Modal.getInstance(document.getElementById('gpDirectorModal')).hide();
}

function removeGpDirector(index) {
    if (confirm('Remove this GP director?')) {
        gpDirectors.splice(index, 1);
        renderGpDirectorsTable();
        updateGpDirectorsJson();
    }
}

function renderGpDirectorsTable() {
    const tbody = document.getElementById('gpDirectorsTableBody');
    tbody.innerHTML = '';

    if (gpDirectors.length === 0) {
        tbody.innerHTML = `
            <tr id="noGpDirectorsRow">
                <td colspan="6" class="text-center text-muted py-3">
                    No GP directors added yet. Click "Add GP Director" to begin.
                </td>
            </tr>
        `;
        return;
    }

    gpDirectors.forEach((d, index) => {
        const positionLabels = {
            'director': 'Director',
            'chairman': 'Chairman',
            'independent_director': 'Independent Director'
        };
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${escapeHtml(d.full_name)}</strong></td>
            <td><small>${d.dob || '-'}</small></td>
            <td><small>${escapeHtml(d.residential_address.substring(0, 30))}...</small></td>
            <td>${d.nationality}</td>
            <td>${positionLabels[d.position] || d.position}</td>
            <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeGpDirector(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateGpDirectorsJson() {
    document.getElementById('gpDirectorsJson').value = JSON.stringify(gpDirectors);
}

function clearGpDirectorForm() {
    document.getElementById('gpDirectorFullName').value = '';
    document.getElementById('gpDirectorFormerNames').value = '';
    document.getElementById('gpDirectorDob').value = '';
    document.getElementById('gpDirectorNationality').value = '';
    document.getElementById('gpDirectorResidenceCountry').value = '';
    document.getElementById('gpDirectorResidentialAddress').value = '';
    document.getElementById('gpDirectorPosition').value = '';
}

// ============================================================
// INVESTORS MANAGEMENT
// ============================================================
let investors = [];

// Auto-populate investors from enquiry data if available
{% if enquiry and enquiry.initial_investors %}
const existingInvestors = {{ enquiry.initial_investors | tojson | safe }};
if (existingInvestors && existingInvestors.length > 0) {
    existingInvestors.forEach(function(inv) {
        investors.push({
            name: inv.name,
            type: inv.type || 'institutional',
            jurisdiction: inv.jurisdiction || '',
            commitment_pct: parseFloat(inv.commitment_pct || '0'),
            commitment_amount: inv.commitment_amount || ''
        });
    });
    // Render after DOM is ready
    setTimeout(function() {
        renderInvestorsTable();
        updateInvestorsJson();
    }, 0);
}
{% endif %}

function getTotalInvestorCommitment() {
    return investors.reduce((sum, inv) => sum + (inv.commitment_pct || 0), 0);
}

function addInvestor() {
    const name = document.getElementById('investorName').value.trim();
    const type = document.getElementById('investorType').value;
    const jurisdiction = document.getElementById('investorJurisdiction').value;
    const commitmentPct = document.getElementById('investorCommitmentPct').value;
    const commitmentAmount = document.getElementById('investorCommitmentAmount').value.trim();

    if (!name || !type || !jurisdiction || !commitmentPct) {
        alert('Please fill in all required fields.');
        return;
    }

    const newCommitment = parseFloat(commitmentPct);
    const currentTotal = getTotalInvestorCommitment();
    const newTotal = currentTotal + newCommitment;

    if (newTotal > 100) {
        alert(`Total commitment cannot exceed 100%. Current total: ${currentTotal.toFixed(2)}%. Adding ${newCommitment}% would make it ${newTotal.toFixed(2)}%.`);
        return;
    }

    investors.push({
        name: name,
        type: type,
        jurisdiction: jurisdiction,
        commitment_pct: newCommitment,
        commitment_amount: commitmentAmount
    });

    renderInvestorsTable();
    updateInvestorsJson();
    clearInvestorForm();
    bootstrap.Modal.getInstance(document.getElementById('investorModal')).hide();
}

function removeInvestor(index) {
    if (confirm('Remove this investor?')) {
        investors.splice(index, 1);
        renderInvestorsTable();
        updateInvestorsJson();
    }
}

function renderInvestorsTable() {
    const tbody = document.getElementById('investorsTableBody');
    tbody.innerHTML = '';

    if (investors.length === 0) {
        tbody.innerHTML = `
            <tr id="noInvestorsRow">
                <td colspan="6" class="text-center text-muted py-3">
                    No investors added yet. Click "Add Investor" to begin.
                </td>
            </tr>
        `;
        updateInvestorTotalDisplay();
        return;
    }

    investors.forEach((inv, index) => {
        const typeLabels = {
            'institutional': 'Institutional',
            'pension_fund': 'Pension Fund',
            'family_office': 'Family Office',
            'hnw': 'HNW Individual',
            'fund_of_funds': 'Fund of Funds',
            'sponsor_affiliate': 'Sponsor/Affiliate',
            'other': 'Other'
        };
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${escapeHtml(inv.name)}</strong></td>
            <td>${typeLabels[inv.type] || inv.type}</td>
            <td>${inv.jurisdiction}</td>
            <td>${inv.commitment_pct}%</td>
            <td>${inv.commitment_amount ? '$' + inv.commitment_amount : '-'}</td>
            <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeInvestor(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });

    // Add total row
    const total = getTotalInvestorCommitment();
    const isValid = Math.abs(total - 100) < 0.01; // Allow for floating point imprecision
    const totalRow = document.createElement('tr');
    totalRow.className = isValid ? 'table-success' : 'table-warning';
    totalRow.innerHTML = `
        <td colspan="3" class="text-end"><strong>Total Commitment:</strong></td>
        <td><strong>${total.toFixed(2)}%</strong></td>
        <td colspan="2">
            ${isValid
                ? '<span class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Valid (100%)</span>'
                : '<span class="text-warning"><i class="bi bi-exclamation-triangle-fill me-1"></i>Must equal 100%</span>'
            }
        </td>
    `;
    tbody.appendChild(totalRow);

    updateInvestorTotalDisplay();
}

function updateInvestorTotalDisplay() {
    const total = getTotalInvestorCommitment();
    const isValid = Math.abs(total - 100) < 0.01;
    const badge = document.getElementById('investorCommitmentBadge');
    if (badge) {
        if (investors.length === 0) {
            badge.className = 'badge bg-secondary';
            badge.innerHTML = 'No investors';
        } else if (isValid) {
            badge.className = 'badge bg-success';
            badge.innerHTML = '<i class="bi bi-check-circle me-1"></i>100%';
        } else {
            badge.className = 'badge bg-warning text-dark';
            badge.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i>${total.toFixed(1)}%`;
        }
    }
}

function updateInvestorsJson() {
    document.getElementById('investorsJson').value = JSON.stringify(investors);
}

function clearInvestorForm() {
    document.getElementById('investorName').value = '';
    document.getElementById('investorType').value = '';
    document.getElementById('investorJurisdiction').value = '';
    document.getElementById('investorCommitmentPct').value = '';
    document.getElementById('investorCommitmentAmount').value = '';
}

// ============================================================
// TARGET COUNTRIES MANAGEMENT
// ============================================================
function initTargetCountries() {
    const otherCheckbox = document.getElementById('countryOther');
    const otherField = document.getElementById('otherCountriesField');
    const targetCountryCheckboxes = document.querySelectorAll('.target-country');

    // Show/hide "Other" text field
    if (otherCheckbox && otherField) {
        otherCheckbox.addEventListener('change', function() {
            otherField.style.display = this.checked ? '' : 'none';
        });
        // Initialize on page load
        if (otherCheckbox.checked) {
            otherField.style.display = '';
        }
    }

    // Update hidden JSON when any checkbox changes
    targetCountryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateTargetCountriesJson);
    });

    // Initialize JSON on page load
    updateTargetCountriesJson();
}

function updateTargetCountriesJson() {
    const selectedCountries = [];
    const checkboxes = document.querySelectorAll('.target-country:checked');
    checkboxes.forEach(cb => selectedCountries.push(cb.value));

    document.getElementById('targetCountriesJson').value = JSON.stringify(selectedCountries);

    // Check if any high-risk countries are selected
    const highRiskSelected = document.querySelectorAll('.high-risk-country:checked');
    if (highRiskSelected.length > 0) {
        console.log('High-risk countries selected:', Array.from(highRiskSelected).map(cb => cb.value));
    }
}

function getSelectedHighRiskCountries() {
    const highRiskSelected = document.querySelectorAll('.high-risk-country:checked');
    return Array.from(highRiskSelected).map(cb => cb.value);
}

// Initialize on DOMContentLoaded
document.addEventListener('DOMContentLoaded', initTargetCountries);

// ============================================================
// DOCUMENT UPLOAD HANDLING
// ============================================================
// UTILITY FUNCTIONS
// ============================================================
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
