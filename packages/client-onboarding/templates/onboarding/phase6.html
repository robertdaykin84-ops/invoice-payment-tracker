{% extends "base.html" %}

{% block title %}Phase 6: Commercial{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item active">Phase 6: Commercial</li>
            </ol>
        </nav>
        <h1 class="h3 mb-1">Commercial Terms</h1>
        <p class="text-muted">Service agreement and fee schedule</p>
    </div>
</div>

<!-- Wizard Stepper -->
<ul class="wizard-stepper mb-4">
    {% for p in phases %}
    <li class="wizard-step {% if p.num < phase %}completed{% elif p.num == phase %}current{% endif %}">
        <div class="step-icon">
            {% if p.num < phase %}
            <i class="bi bi-check"></i>
            {% else %}
            <i class="bi {{ p.icon }}"></i>
            {% endif %}
        </div>
        <span class="step-label">{{ p.name }}</span>
    </li>
    {% endfor %}
</ul>

<div class="row">
    <div class="col-lg-8">
        <!-- Service Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-list-check me-2"></i>
                Services Required
            </div>
            <div class="card-body">
                <form id="commercialForm">
                    <h6 class="mb-3">Administration Services</h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_nav" checked>
                                <label class="form-check-label" for="service_nav">
                                    <strong>NAV Calculation</strong>
                                    <small class="text-muted d-block">Monthly/Quarterly valuations</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_investor" checked>
                                <label class="form-check-label" for="service_investor">
                                    <strong>Investor Services</strong>
                                    <small class="text-muted d-block">Investor communications & reporting</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_accounting" checked>
                                <label class="form-check-label" for="service_accounting">
                                    <strong>Fund Accounting</strong>
                                    <small class="text-muted d-block">Management & performance fees</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_aml">
                                <label class="form-check-label" for="service_aml">
                                    <strong>AML/KYC Services</strong>
                                    <small class="text-muted d-block">Ongoing investor due diligence</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_ta" checked>
                                <label class="form-check-label" for="service_ta">
                                    <strong>Transfer Agency</strong>
                                    <small class="text-muted d-block">Subscription & redemption processing</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_reg">
                                <label class="form-check-label" for="service_reg">
                                    <strong>Regulatory Filings</strong>
                                    <small class="text-muted d-block">JFSC notifications & reporting</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <h6 class="mb-3">Corporate Services</h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_director" checked>
                                <label class="form-check-label" for="service_director">
                                    <strong>Director Services (GP)</strong>
                                    <small class="text-muted d-block">2 independent directors provided</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_cosec" checked>
                                <label class="form-check-label" for="service_cosec">
                                    <strong>Company Secretary</strong>
                                    <small class="text-muted d-block">GP company secretarial services</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Fee Schedule -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-currency-pound me-2"></i>Fee Schedule</span>
                <span class="badge bg-primary"><i class="bi bi-robot me-1"></i>AI Generated</span>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    Fee proposal generated based on fund size ($500M), structure complexity (Low), and services selected.
                </div>

                <table class="table table-hover mb-4" id="fee-table">
                    <thead class="table-light">
                        <tr>
                            <th>Service</th>
                            <th>Fee Type</th>
                            <th class="text-end">Annual Fee</th>
                        </tr>
                    </thead>
                    <tbody id="fee-table-body">
                        <!-- Dynamic content populated by JavaScript -->
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="2">Total Annual Fee</th>
                            <th class="text-end text-primary" id="annual-total">£148,000</th>
                        </tr>
                        <tr>
                            <td colspan="2"><small>Effective rate on NAV (at target)</small></td>
                            <td class="text-end"><small class="text-muted" id="effective-bps">2.96 bps</small></td>
                        </tr>
                    </tfoot>
                </table>

                <h6 class="mb-3">One-Time Setup Fees</h6>
                <table class="table table-sm mb-4" id="setup-table">
                    <tbody id="setup-table-body">
                        <!-- Dynamic content populated by JavaScript -->
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th>Total Setup</th>
                            <th class="text-end" id="setup-total">£20,000</th>
                        </tr>
                    </tfoot>
                </table>

                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" id="btn-recalculate" type="button">
                        <i class="bi bi-arrow-clockwise me-1"></i> Recalculate Fees
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" type="button">
                        <i class="bi bi-pencil me-1"></i> Customize Proposal
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" type="button">
                        <i class="bi bi-download me-1"></i> Export Proposal
                    </button>
                </div>
            </div>
        </div>

        <!-- Service Agreement -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-file-earmark-text me-2"></i>
                Service Agreement
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center gap-3 mb-4">
                    <div class="bg-light rounded p-3 text-center" style="width: 80px;">
                        <i class="bi bi-file-pdf text-danger" style="font-size: 2rem;"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Administration Agreement</h6>
                        <small class="text-muted">Standard AIFM administration agreement template</small>
                        <div class="mt-2">
                            <button class="btn btn-outline-primary btn-sm me-2">
                                <i class="bi bi-eye me-1"></i> Preview
                            </button>
                            <button class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-download me-1"></i> Download
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="terms_confirm" checked>
                    <label class="form-check-label" for="terms_confirm">
                        I confirm the fee schedule has been reviewed and approved by the sponsor
                    </label>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="agreement_confirm" checked>
                    <label class="form-check-label" for="agreement_confirm">
                        Service agreement terms have been agreed in principle
                    </label>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="d-flex justify-content-between mb-4">
            <a href="{{ url_for('onboarding_phase', onboarding_id=onboarding_id, phase=5) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to Phase 5
            </a>
            <div>
                <button class="btn btn-outline-primary me-2" type="button">
                    <i class="bi bi-save me-1"></i> Save Draft
                </button>
                <a href="{{ url_for('onboarding_phase', onboarding_id=onboarding_id, phase=7) }}" class="btn btn-primary">
                    Complete Onboarding <i class="bi bi-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-check2-square me-2"></i>
                Phase 6 Checklist
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-check-circle text-success"></i>
                        <span>Services selected</span>
                    </li>
                    <li class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-check-circle text-success"></i>
                        <span>Fee schedule generated</span>
                    </li>
                    <li class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-check-circle text-success"></i>
                        <span>Terms confirmed</span>
                    </li>
                    <li class="d-flex align-items-center gap-2">
                        <i class="bi bi-check-circle text-success"></i>
                        <span>Agreement prepared</span>
                    </li>
                </ul>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-calculator me-2"></i>
                Fee Summary
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Annual Fees</span>
                    <strong id="sidebar-annual">£148,000</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Setup Fees</span>
                    <strong id="sidebar-setup">£20,000</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Year 1 Total</span>
                    <strong class="text-primary" id="sidebar-year1">£168,000</strong>
                </div>
            </div>
        </div>

        <div class="card border-success">
            <div class="card-header bg-success bg-opacity-10">
                <i class="bi bi-check-circle me-2 text-success"></i>
                Approval Status
            </div>
            <div class="card-body text-center">
                <span class="badge bg-success mb-2">APPROVED</span>
                <p class="small text-muted mb-0">
                    MLRO approved on 02 Feb 2026
                </p>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Service checkbox mappings
    const serviceCheckboxes = {
        'service_nav': 'nav',
        'service_investor': 'investor',
        'service_accounting': 'accounting',
        'service_aml': 'aml',
        'service_ta': 'ta',
        'service_reg': 'reg',
        'service_director': 'director',
        'service_cosec': 'cosec'
    };

    // Default parameters
    const fundSize = 500000000;  // $500M - could be dynamic from session
    const numInvestors = 50;
    const numDirectors = 2;

    // Get selected services
    function getSelectedServices() {
        const services = [];
        for (const [checkboxId, serviceId] of Object.entries(serviceCheckboxes)) {
            const checkbox = document.getElementById(checkboxId);
            if (checkbox && checkbox.checked) {
                services.push(serviceId);
            }
        }
        return services;
    }

    // Format currency
    function formatCurrency(amount) {
        return '£' + amount.toLocaleString('en-GB');
    }

    // Update fee tables
    async function updateFees() {
        const services = getSelectedServices();

        try {
            const response = await fetch('/api/fees/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fund_size: fundSize,
                    services: services,
                    num_investors: numInvestors,
                    num_directors: numDirectors,
                    complexity: 'low',
                    include_setup: true
                })
            });

            const result = await response.json();

            if (result.status === 'ok') {
                // Update service breakdown table
                const feeTableBody = document.getElementById('fee-table-body');
                if (feeTableBody) {
                    let html = '';
                    for (const service of result.service_breakdown) {
                        const feeType = service.per_unit ?
                            `Per ${service.per_unit} (${service.per_unit === 'investor' ? numInvestors : numDirectors})` :
                            'Fixed annual';
                        html += `
                            <tr>
                                <td>${service.name}</td>
                                <td><small class="text-muted">${feeType}</small></td>
                                <td class="text-end">${formatCurrency(service.adjusted_fee)}</td>
                            </tr>
                        `;
                    }
                    feeTableBody.innerHTML = html;
                }

                // Update setup table
                const setupTableBody = document.getElementById('setup-table-body');
                if (setupTableBody) {
                    let html = '';
                    for (const setup of result.setup_breakdown) {
                        html += `
                            <tr>
                                <td>${setup.name}</td>
                                <td class="text-end">${setup.amount > 0 ? formatCurrency(setup.amount) : 'Included'}</td>
                            </tr>
                        `;
                    }
                    setupTableBody.innerHTML = html;
                }

                // Update totals
                const annualTotal = document.getElementById('annual-total');
                if (annualTotal) annualTotal.textContent = result.annual_total_formatted;

                const setupTotal = document.getElementById('setup-total');
                if (setupTotal) setupTotal.textContent = result.setup_total_formatted;

                const effectiveBps = document.getElementById('effective-bps');
                if (effectiveBps) effectiveBps.textContent = result.effective_bps + ' bps';

                // Update sidebar
                const sidebarAnnual = document.getElementById('sidebar-annual');
                if (sidebarAnnual) sidebarAnnual.textContent = result.annual_total_formatted;

                const sidebarSetup = document.getElementById('sidebar-setup');
                if (sidebarSetup) sidebarSetup.textContent = result.setup_total_formatted;

                const sidebarYear1 = document.getElementById('sidebar-year1');
                if (sidebarYear1) sidebarYear1.textContent = result.year1_total_formatted;
            }
        } catch (error) {
            console.error('Fee calculation error:', error);
        }
    }

    // Bind change listeners to all service checkboxes
    for (const checkboxId of Object.keys(serviceCheckboxes)) {
        const checkbox = document.getElementById(checkboxId);
        if (checkbox) {
            checkbox.addEventListener('change', updateFees);
        }
    }

    // Bind recalculate button
    const btnRecalculate = document.getElementById('btn-recalculate');
    if (btnRecalculate) {
        btnRecalculate.addEventListener('click', updateFees);
    }

    // Initial calculation on page load
    updateFees();
});
</script>
{% endblock %}
