{% extends "base.html" %}

{% block title %}Upload Invoice - Invoice Tracker{% endblock %}

{% block extra_css %}
<style>
    .upload-container {
        max-width: 700px;
        margin: 0 auto;
    }

    .upload-area {
        border: 2px dashed var(--gray-300, #d1d5db);
        border-radius: 1rem;
        background: #fff;
        padding: 3rem 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-area:hover {
        border-color: var(--primary-blue);
        background-color: var(--light-blue, #eff6ff);
    }

    .upload-area.drag-over {
        border-color: var(--primary-blue);
        background-color: var(--light-blue, #eff6ff);
        transform: scale(1.01);
    }

    .upload-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 1.5rem;
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue, #3b82f6) 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 2rem;
    }

    .upload-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 0.5rem;
    }

    .upload-subtitle {
        color: var(--gray-500);
        margin-bottom: 1.5rem;
    }

    .file-types {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
    }

    .file-type-badge {
        background-color: var(--gray-100);
        color: var(--gray-600);
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .file-input {
        display: none;
    }

    .selected-file {
        display: none;
        margin-top: 1.5rem;
        padding: 1rem;
        background: var(--light-blue, #eff6ff);
        border-radius: 0.5rem;
        text-align: left;
    }

    .selected-file.visible {
        display: block;
    }

    .selected-file .file-name {
        font-weight: 600;
        color: var(--gray-800);
    }

    .selected-file .file-size {
        font-size: 0.875rem;
        color: var(--gray-500);
    }

    .selected-file .remove-file {
        color: #dc3545;
        cursor: pointer;
        font-size: 0.875rem;
    }

    .selected-file .remove-file:hover {
        text-decoration: underline;
    }

    /* Processing overlay */
    .processing-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .processing-overlay.active {
        display: flex;
    }

    .processing-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid var(--gray-200);
        border-top-color: var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .processing-text {
        margin-top: 1.5rem;
        font-size: 1.125rem;
        color: var(--gray-700);
        text-align: center;
    }

    .processing-subtext {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: var(--gray-500);
    }

    /* Instructions card */
    .instructions-card {
        background: var(--light-blue, #eff6ff);
        border: 1px solid #bfdbfe;
        border-radius: 0.75rem;
        padding: 1.25rem;
    }

    .instructions-card h6 {
        color: var(--primary-blue);
        margin-bottom: 0.75rem;
    }

    .instructions-card ul {
        margin-bottom: 0;
        padding-left: 1.25rem;
    }

    .instructions-card li {
        color: var(--gray-600);
        margin-bottom: 0.25rem;
    }

    .btn-upload {
        padding: 0.75rem 2rem;
        font-size: 1rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <!-- Page Header -->
    <div class="text-center mb-4">
        <h2 class="mb-2">Upload Invoice</h2>
        <p class="text-muted">Upload your invoice and we'll automatically extract the details using AI</p>
    </div>

    <!-- Upload Card -->
    <div class="card mb-4">
        <div class="card-body p-4">
            <form action="{{ url_for('upload') }}" method="POST" enctype="multipart/form-data" id="upload-form">
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">
                        <i class="bi bi-cloud-arrow-up"></i>
                    </div>
                    <h4 class="upload-title">Drag & drop your invoice here</h4>
                    <p class="upload-subtitle">or click to browse files</p>
                    <div class="file-types">
                        <span class="file-type-badge"><i class="bi bi-file-earmark-pdf me-1"></i>PDF</span>
                        <span class="file-type-badge"><i class="bi bi-file-earmark-image me-1"></i>PNG</span>
                        <span class="file-type-badge"><i class="bi bi-file-earmark-image me-1"></i>JPG</span>
                    </div>
                    <input type="file" name="file" id="file-input" class="file-input" accept=".pdf,.png,.jpg,.jpeg" required>
                </div>

                <!-- Selected File Display -->
                <div class="selected-file" id="selected-file">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-file-earmark me-2"></i>
                            <span class="file-name" id="file-name"></span>
                            <span class="file-size" id="file-size"></span>
                        </div>
                        <span class="remove-file" id="remove-file"><i class="bi bi-x-lg"></i> Remove</span>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-upload" id="submit-btn" disabled>
                        <i class="bi bi-cpu me-2"></i>Process Invoice
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Instructions -->
    <div class="instructions-card">
        <h6><i class="bi bi-info-circle me-2"></i>Tips for best results</h6>
        <ul>
            <li>Ensure the invoice is clear and readable</li>
            <li>Include the full invoice in the image or PDF</li>
            <li>Supported formats: PDF, PNG, JPG (max 16MB)</li>
            <li>After processing, you'll review and verify the extracted data before saving</li>
        </ul>
    </div>
</div>

<!-- Processing Overlay -->
<div class="processing-overlay" id="processing-overlay">
    <div class="processing-spinner"></div>
    <div class="processing-text">Processing your invoice...</div>
    <div class="processing-subtext">AI is extracting invoice details. This may take a few seconds.</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const selectedFile = document.getElementById('selected-file');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const removeFile = document.getElementById('remove-file');
    const submitBtn = document.getElementById('submit-btn');
    const uploadForm = document.getElementById('upload-form');
    const processingOverlay = document.getElementById('processing-overlay');

    // Click to select file
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    // Drag and drop handlers
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    // File input change handler
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });

    // Handle selected file
    function handleFile(file) {
        // Validate file type
        const validTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
        if (!validTypes.includes(file.type)) {
            alert('Invalid file type. Please upload a PDF, PNG, or JPG file.');
            return;
        }

        // Validate file size (16MB)
        if (file.size > 16 * 1024 * 1024) {
            alert('File is too large. Maximum size is 16MB.');
            return;
        }

        // Update the file input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;

        // Show selected file info
        fileName.textContent = file.name;
        fileSize.textContent = `(${formatFileSize(file.size)})`;
        selectedFile.classList.add('visible');
        submitBtn.disabled = false;
    }

    // Format file size
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Remove file
    removeFile.addEventListener('click', (e) => {
        e.stopPropagation();
        fileInput.value = '';
        selectedFile.classList.remove('visible');
        submitBtn.disabled = true;
    });

    // Form submit - show processing overlay
    uploadForm.addEventListener('submit', (e) => {
        // Show processing overlay
        processingOverlay.classList.add('active');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
    });
</script>
{% endblock %}
