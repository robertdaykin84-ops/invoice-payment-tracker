{% extends "base.html" %}

{% block title %}Upload Invoices - Invoice Tracker{% endblock %}

{% block extra_css %}
<style>
    .upload-container {
        max-width: 700px;
        margin: 0 auto;
    }

    .upload-area {
        border: 2px dashed #7BBAF2;
        border-radius: 1rem;
        background: linear-gradient(180deg, #fff 0%, #EBF5FF 100%);
        padding: 3rem 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .upload-area:hover {
        border-color: var(--primary-blue);
        background: linear-gradient(180deg, #EBF5FF 0%, #fff 100%);
        box-shadow: 0 8px 25px rgba(84, 166, 237, 0.15);
    }

    .upload-area.drag-over {
        border-color: var(--accent-green, #10B981);
        border-style: solid;
        background: linear-gradient(180deg, #ECFDF5 0%, #D1FAE5 100%);
        transform: scale(1.01);
    }

    .upload-area.processing {
        pointer-events: none;
        opacity: 0.7;
    }

    .upload-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 1.5rem;
        background: linear-gradient(135deg, #54A6ED 0%, #3B8FD9 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 2rem;
        box-shadow: 0 8px 25px rgba(84, 166, 237, 0.35);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .upload-area:hover .upload-icon {
        transform: scale(1.05);
        box-shadow: 0 12px 30px rgba(84, 166, 237, 0.45);
    }

    .upload-area.drag-over .upload-icon {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        box-shadow: 0 12px 30px rgba(16, 185, 129, 0.45);
    }

    .upload-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 0.5rem;
    }

    .upload-subtitle {
        color: var(--gray-500);
        margin-bottom: 1.5rem;
    }

    .file-types {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .file-type-badge {
        background-color: var(--gray-100);
        color: var(--gray-600);
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .file-input {
        display: none;
    }

    /* Processing overlay - CoreWorker Dark Theme */
    .processing-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(26, 26, 46, 0.98) 0%, rgba(22, 33, 62, 0.98) 100%);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .processing-overlay.active {
        display: flex;
    }

    .processing-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(84, 166, 237, 0.2);
        border-top-color: #54A6ED;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .processing-text {
        margin-top: 1.5rem;
        font-size: 1.25rem;
        font-weight: 600;
        color: #fff;
        text-align: center;
        font-family: 'Outfit', sans-serif;
    }

    .processing-subtext {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: #7BBAF2;
    }

    .processing-progress {
        margin-top: 1.5rem;
        width: 300px;
    }

    .progress {
        height: 8px;
        border-radius: 4px;
        background-color: rgba(84, 166, 237, 0.2);
    }

    .progress-bar {
        background: linear-gradient(135deg, #54A6ED 0%, #10B981 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .file-list {
        margin-top: 1rem;
        max-width: 400px;
        text-align: left;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 0.625rem 0.75rem;
        border-radius: 0.5rem;
        background: rgba(255, 255, 255, 0.08);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        color: #fff;
    }

    .file-item:last-child {
        margin-bottom: 0;
    }

    .file-item i {
        margin-right: 0.625rem;
        color: rgba(255, 255, 255, 0.5);
        font-size: 1rem;
    }

    .file-item.completed {
        background: rgba(16, 185, 129, 0.15);
    }

    .file-item.completed i {
        color: #10B981;
    }

    .file-item.processing {
        background: rgba(84, 166, 237, 0.15);
    }

    .file-item.processing i {
        color: #54A6ED;
        animation: spin 1s linear infinite;
    }

    .file-item.error {
        background: rgba(239, 68, 68, 0.15);
    }

    .file-item.error i {
        color: #ef4444;
    }

    .file-item-name {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .file-item-status {
        font-size: 0.75rem;
        margin-left: 0.5rem;
        font-weight: 500;
    }

    /* Instructions card - CoreWorker styled */
    .instructions-card {
        background: linear-gradient(135deg, #EBF5FF 0%, #D6EBFF 100%);
        border: 1px solid rgba(84, 166, 237, 0.3);
        border-radius: 0.75rem;
        padding: 1.25rem;
    }

    .instructions-card h6 {
        color: #3B8FD9;
        margin-bottom: 0.75rem;
        font-family: 'Outfit', sans-serif;
        font-weight: 600;
    }

    .instructions-card ul {
        margin-bottom: 0;
        padding-left: 1.25rem;
    }

    .instructions-card li {
        color: #374151;
        margin-bottom: 0.375rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <!-- Page Header -->
    <header class="text-center mb-4">
        <div class="d-inline-flex align-items-center gap-2 mb-2">
            <span class="badge" style="background: linear-gradient(135deg, #54A6ED 0%, #3B8FD9 100%); font-size: 0.7rem; padding: 0.35rem 0.75rem;">
                <i class="bi bi-stars me-1" aria-hidden="true"></i>AI-POWERED
            </span>
        </div>
        <h1 class="h2 mb-2" style="font-family: 'Outfit', sans-serif; font-weight: 700;">Upload Invoices</h1>
        <p class="text-muted">Drop your invoices here - AI extraction starts automatically</p>
    </header>

    <!-- Upload Card -->
    <section aria-label="Invoice upload area">
        <div class="card mb-4">
            <div class="card-body p-4">
            <div class="upload-area" id="upload-area" role="button" tabindex="0"
                 aria-label="Upload area. Click or press Enter to select invoice files, or drag and drop files here."
                 aria-describedby="upload-instructions">
                <div class="upload-icon" aria-hidden="true">
                    <i class="bi bi-cloud-arrow-up"></i>
                </div>
                <h2 class="upload-title">Drag & drop invoices here</h2>
                <p class="upload-subtitle" id="upload-instructions">or click to browse - processing starts automatically</p>
                <div class="file-types" aria-label="Supported file formats">
                    <span class="file-type-badge"><i class="bi bi-file-earmark-pdf me-1" aria-hidden="true"></i>PDF</span>
                    <span class="file-type-badge"><i class="bi bi-file-earmark-image me-1" aria-hidden="true"></i>PNG</span>
                    <span class="file-type-badge"><i class="bi bi-file-earmark-image me-1" aria-hidden="true"></i>JPG</span>
                </div>
                <input type="file" id="file-input" class="file-input" accept=".pdf,.png,.jpg,.jpeg" multiple
                       aria-label="Select invoice files to upload">
            </div>
        </div>
    </div>
    </section>

    <!-- Instructions -->
    <aside class="instructions-card" aria-labelledby="tips-heading">
        <h2 class="h6" id="tips-heading"><i class="bi bi-info-circle me-2" aria-hidden="true"></i>Tips for best results</h2>
        <ul>
            <li>You can upload multiple invoices at once</li>
            <li>Processing starts automatically when you drop or select files</li>
            <li>Supported formats: PDF, PNG, JPG (max 16MB each)</li>
            <li>After processing, you'll review each invoice before saving</li>
        </ul>
    </aside>
</div>

<!-- Processing Overlay -->
<div class="processing-overlay" id="processing-overlay" role="dialog" aria-modal="true" aria-labelledby="processing-text">
    <div class="processing-spinner"></div>
    <div class="processing-text" id="processing-text">Processing invoices...</div>
    <div class="processing-subtext" id="processing-subtext">AI is extracting invoice details</div>
    <div class="processing-progress">
        <div class="progress">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>
    </div>
    <div class="file-list" id="file-list"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const processingOverlay = document.getElementById('processing-overlay');
    const processingText = document.getElementById('processing-text');
    const processingSubtext = document.getElementById('processing-subtext');
    const progressBar = document.getElementById('progress-bar');
    const fileList = document.getElementById('file-list');

    // Click to select files
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });

    // Keyboard support for upload area (Enter/Space)
    uploadArea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            fileInput.click();
        }
    });

    // Drag and drop handlers
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
            processFiles(files);
        }
    });

    // File input change handler - auto process
    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            processFiles(files);
        }
    });

    // Validate file
    function validateFile(file) {
        const validTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
        if (!validTypes.includes(file.type)) {
            return { valid: false, error: 'Invalid file type' };
        }
        if (file.size > 16 * 1024 * 1024) {
            return { valid: false, error: 'File too large (max 16MB)' };
        }
        return { valid: true };
    }

    // Process multiple files
    async function processFiles(files) {
        // Filter valid files
        const validFiles = [];
        const invalidFiles = [];

        for (const file of files) {
            const validation = validateFile(file);
            if (validation.valid) {
                validFiles.push(file);
            } else {
                invalidFiles.push({ file, error: validation.error });
            }
        }

        if (validFiles.length === 0) {
            alert('No valid files selected. Please upload PDF, PNG, or JPG files (max 16MB each).');
            return;
        }

        // Show processing overlay
        processingOverlay.classList.add('active');
        uploadArea.classList.add('processing');

        // Build file list UI
        fileList.innerHTML = validFiles.map((f, i) => `
            <div class="file-item" id="file-item-${i}">
                <i class="bi bi-hourglass-split"></i>
                <span class="file-item-name">${f.name}</span>
                <span class="file-item-status text-muted">Waiting...</span>
            </div>
        `).join('');

        const processedFiles = [];
        let completed = 0;

        // Process each file sequentially
        for (let i = 0; i < validFiles.length; i++) {
            const file = validFiles[i];
            const fileItem = document.getElementById(`file-item-${i}`);

            // Update UI for current file
            fileItem.querySelector('i').className = 'bi bi-arrow-repeat';
            fileItem.classList.add('processing');
            fileItem.querySelector('.file-item-status').textContent = 'Processing...';
            processingText.textContent = `Processing invoice ${i + 1} of ${validFiles.length}`;
            processingSubtext.textContent = file.name;

            try {
                // Upload and process file
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('{{ url_for("upload") }}', {
                    method: 'POST',
                    body: formData
                });

                if (response.redirected) {
                    // Extract filename from redirect URL
                    const redirectUrl = response.url;
                    processedFiles.push({ success: true, url: redirectUrl, file: file.name });

                    fileItem.querySelector('i').className = 'bi bi-check-circle-fill';
                    fileItem.classList.remove('processing');
                    fileItem.classList.add('completed');
                    fileItem.querySelector('.file-item-status').textContent = 'Done';
                    fileItem.querySelector('.file-item-status').className = 'file-item-status text-success';
                } else {
                    const data = await response.json();
                    if (data.success) {
                        processedFiles.push({ success: true, redirect: data.redirect, file: file.name });

                        fileItem.querySelector('i').className = 'bi bi-check-circle-fill';
                        fileItem.classList.remove('processing');
                        fileItem.classList.add('completed');
                        fileItem.querySelector('.file-item-status').textContent = 'Done';
                        fileItem.querySelector('.file-item-status').className = 'file-item-status text-success';
                    } else {
                        throw new Error(data.error || 'Processing failed');
                    }
                }
            } catch (error) {
                processedFiles.push({ success: false, error: error.message, file: file.name });

                fileItem.querySelector('i').className = 'bi bi-x-circle-fill';
                fileItem.classList.remove('processing');
                fileItem.classList.add('error');
                fileItem.querySelector('.file-item-status').textContent = 'Error';
                fileItem.querySelector('.file-item-status').className = 'file-item-status text-danger';
            }

            completed++;
            progressBar.style.width = `${(completed / validFiles.length) * 100}%`;
        }

        // All done - redirect to review all successful invoices
        const successfulFiles = processedFiles.filter(f => f.success);

        processingText.textContent = 'Processing complete!';
        processingSubtext.textContent = `${successfulFiles.length} invoice(s) ready for review`;

        setTimeout(() => {
            if (successfulFiles.length > 0) {
                // Extract filenames from URLs/redirects
                const filenames = successfulFiles.map(f => {
                    if (f.url) {
                        // Extract filename from URL like /review/filename.jpg
                        const match = f.url.match(/\/review\/([^?]+)/);
                        return match ? match[1] : null;
                    } else if (f.redirect) {
                        const match = f.redirect.match(/\/review\/([^?]+)/);
                        return match ? match[1] : null;
                    }
                    return null;
                }).filter(f => f);

                // Redirect to review with all filenames in queue
                if (filenames.length > 0) {
                    const queueParam = encodeURIComponent(filenames.join(','));
                    window.location.href = `/review/${filenames[0]}?queue=${queueParam}`;
                }
            } else {
                // No successful uploads
                processingOverlay.classList.remove('active');
                uploadArea.classList.remove('processing');
                alert('All files failed to process. Please try again.');
            }
        }, 1000);
    }
</script>
{% endblock %}
