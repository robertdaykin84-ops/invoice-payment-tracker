{% extends "base.html" %}

{% block title %}Phase 3: Commercial{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item active">Phase 3: Commercial</li>
            </ol>
        </nav>
        <h1 class="h3 mb-1">Commercial Terms</h1>
        <p class="text-muted">Service agreement and fee schedule</p>
    </div>
</div>

<!-- Wizard Stepper -->
<ul class="wizard-stepper mb-4">
    {% for p in phases %}
    <li class="wizard-step {% if p.num < phase %}completed{% elif p.num == phase %}current{% endif %}">
        <div class="step-icon">
            {% if p.num < phase %}
            <i class="bi bi-check"></i>
            {% else %}
            <i class="bi {{ p.icon }}"></i>
            {% endif %}
        </div>
        <span class="step-label">{{ p.name }}</span>
    </li>
    {% endfor %}
</ul>

<div class="row">
    <div class="col-lg-8">
        <!-- Service Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-list-check me-2"></i>
                Services Required
            </div>
            <div class="card-body">
                <form id="commercialForm">
                    <h6 class="mb-3">Administration Services</h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_nav"
                                       {{ 'checked' if enquiry and enquiry.services_required and 'nav' in enquiry.services_required }}>
                                <label class="form-check-label" for="service_nav">
                                    <strong>NAV Calculation</strong>
                                    <small class="text-muted d-block">Monthly/Quarterly valuations</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_investor"
                                       {{ 'checked' if enquiry and enquiry.services_required and 'investor' in enquiry.services_required }}>
                                <label class="form-check-label" for="service_investor">
                                    <strong>Investor Services</strong>
                                    <small class="text-muted d-block">Investor communications & reporting</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_accounting"
                                       {{ 'checked' if enquiry and enquiry.services_required and 'accounting' in enquiry.services_required }}>
                                <label class="form-check-label" for="service_accounting">
                                    <strong>Fund Accounting</strong>
                                    <small class="text-muted d-block">Management & performance fees</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_aml"
                                       {{ 'checked' if enquiry and enquiry.services_required and 'aml' in enquiry.services_required }}>
                                <label class="form-check-label" for="service_aml">
                                    <strong>AML/KYC Services</strong>
                                    <small class="text-muted d-block">Ongoing investor due diligence</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_ta"
                                       {{ 'checked' if enquiry and enquiry.services_required and 'ta' in enquiry.services_required }}>
                                <label class="form-check-label" for="service_ta">
                                    <strong>Transfer Agency</strong>
                                    <small class="text-muted d-block">Subscription & redemption processing</small>
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_reg"
                                       {{ 'checked' if enquiry and enquiry.services_required and 'reg' in enquiry.services_required }}>
                                <label class="form-check-label" for="service_reg">
                                    <strong>Regulatory Filings</strong>
                                    <small class="text-muted d-block">JFSC notifications & reporting</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <h6 class="mb-3">Corporate Services</h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_director"
                                       {{ 'checked' if enquiry and enquiry.services_required and 'director' in enquiry.services_required }}>
                                <label class="form-check-label" for="service_director">
                                    <strong>Director Services (GP)</strong>
                                    <small class="text-muted d-block">2 independent directors provided</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="service_cosec"
                                       {{ 'checked' if enquiry and enquiry.services_required and 'cosec' in enquiry.services_required }}>
                                <label class="form-check-label" for="service_cosec">
                                    <strong>Company Secretary</strong>
                                    <small class="text-muted d-block">GP company secretarial services</small>
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- Fee Structure Selection -->
                    <h6 class="mb-3">Fee Structure</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Fee Structure</label>
                            <select class="form-select" id="feeStructure">
                                <option value="fixed" selected>Fixed Annual</option>
                                <option value="per_transaction">Per Transaction</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="transactionsField" style="display: none;">
                            <label class="form-label">Estimated Transactions (Year 1)</label>
                            <input type="number" class="form-control" id="estimatedTransactions" value="100" min="1">
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Fee Schedule -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-currency-pound me-2"></i>Fee Schedule</span>
                <span class="badge bg-primary"><i class="bi bi-robot me-1"></i>AI Generated</span>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    Fee proposal generated based on fund size (${{ enquiry.target_size|default('500,000,000') if enquiry else '500,000,000' }}), structure complexity (Low), and services selected.
                </div>

                <div class="table-responsive">
                <table class="table table-hover mb-4" id="fee-table">
                    <thead class="table-light">
                        <tr>
                            <th>Service</th>
                            <th>Fee Type</th>
                            <th class="text-end">Annual Fee</th>
                            <th class="text-end">Cost Per TX</th>
                            <th class="text-end">TX/Year</th>
                            <th class="text-end">Total TX Fee</th>
                            <th style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="fee-table-body">
                        <!-- Dynamic content populated by JavaScript -->
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th colspan="2">Total Fixed Fee</th>
                            <th class="text-end" id="total-fixed-fee">£0</th>
                            <th colspan="4"></th>
                        </tr>
                        <tr>
                            <th colspan="2">Total Approx TX Fee</th>
                            <th colspan="3"></th>
                            <th class="text-end" id="total-tx-fee">£0</th>
                            <th></th>
                        </tr>
                        <tr class="table-primary">
                            <th colspan="2">Total Approx Fee</th>
                            <th class="text-end text-primary" id="annual-total">£148,000</th>
                            <th colspan="4"></th>
                        </tr>
                        <tr>
                            <td colspan="2"><small>Effective rate on NAV (at target)</small></td>
                            <td class="text-end"><small class="text-muted" id="effective-bps">2.96 bps</small></td>
                            <td colspan="4"></td>
                        </tr>
                    </tfoot>
                </table>
                </div>
                <button type="button" class="btn btn-outline-success btn-sm mb-3" id="btn-add-service">
                    <i class="bi bi-plus-circle me-1"></i> Add Service
                </button>

                <h6 class="mb-3">One-Time Setup Fees</h6>
                <table class="table table-sm mb-4" id="setup-table">
                    <tbody id="setup-table-body">
                        <!-- Dynamic content populated by JavaScript -->
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <th>Total Setup</th>
                            <th class="text-end" id="setup-total">£20,000</th>
                        </tr>
                    </tfoot>
                </table>

                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="btn-export" type="button">
                        <i class="bi bi-download me-1"></i> Export Proposal
                    </button>
                </div>
            </div>
        </div>

        <!-- Service Agreement -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-file-earmark-text me-2"></i>
                Service Agreement
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center gap-3 mb-4">
                    <div class="bg-light rounded p-3 text-center" style="width: 80px;">
                        <i class="bi bi-file-pdf text-danger" style="font-size: 2rem;"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">Administration Agreement</h6>
                        <small class="text-muted">Standard AIFM administration agreement template</small>
                        <div class="mt-2">
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="window.open('/api/onboarding/{{ onboarding_id }}/admin-agreement', '_blank')">
                                <i class="bi bi-eye me-1"></i> Preview
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="window.location.href='/api/onboarding/{{ onboarding_id }}/admin-agreement?download=1'">
                                <i class="bi bi-download me-1"></i> Download
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="terms_confirm" checked>
                    <label class="form-check-label" for="terms_confirm">
                        I confirm the fee schedule has been reviewed and approved by the sponsor
                    </label>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="agreement_confirm" checked>
                    <label class="form-check-label" for="agreement_confirm">
                        Service agreement terms have been agreed in principle
                    </label>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="d-flex justify-content-between mb-4">
            <a href="{{ url_for('onboarding_phase', onboarding_id=onboarding_id, phase=2) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to Phase 2
            </a>
            <div>
                <button class="btn btn-outline-primary me-2" type="button" id="btn-save-draft">
                    <i class="bi bi-save me-1"></i> Save Draft
                </button>
                <a href="{{ url_for('onboarding_phase', onboarding_id=onboarding_id, phase=4) }}" class="btn btn-primary">
                    Continue to Phase 4 <i class="bi bi-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-check2-square me-2"></i>
                Phase 3 Checklist
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-check-circle text-success"></i>
                        <span>Services selected</span>
                    </li>
                    <li class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-check-circle text-success"></i>
                        <span>Fee schedule generated</span>
                    </li>
                    <li class="d-flex align-items-center gap-2 mb-2">
                        <i class="bi bi-check-circle text-success"></i>
                        <span>Terms confirmed</span>
                    </li>
                    <li class="d-flex align-items-center gap-2">
                        <i class="bi bi-check-circle text-success"></i>
                        <span>Agreement prepared</span>
                    </li>
                </ul>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-calculator me-2"></i>
                Fee Summary
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Annual Fees</span>
                    <strong id="sidebar-annual">£148,000</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Setup Fees</span>
                    <strong id="sidebar-setup">£20,000</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Year 1 Total</span>
                    <strong class="text-primary" id="sidebar-year1">£168,000</strong>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const onboardingId = '{{ onboarding_id }}';

    // Service checkbox mappings
    const serviceCheckboxes = {
        'service_nav': 'nav',
        'service_investor': 'investor',
        'service_accounting': 'accounting',
        'service_aml': 'aml',
        'service_ta': 'ta',
        'service_reg': 'reg',
        'service_director': 'director',
        'service_cosec': 'cosec'
    };

    // Parameters from enquiry data (dynamic)
    const fundSize = parseInt('{{ enquiry.target_size|default("500000000") if enquiry else "500000000" }}'.replace(/,/g, ''));
    const numInvestors = {{ enquiry.initial_investors|length if enquiry and enquiry.initial_investors else 50 }};
    const numDirectors = {{ num_directors|default(3) }};

    // Track custom rows added by user
    let customRows = [];
    let isEditable = false;

    // Fee structure toggle
    const feeStructureSelect = document.getElementById('feeStructure');
    const transactionsField = document.getElementById('transactionsField');
    const estimatedTransactionsInput = document.getElementById('estimatedTransactions');

    if (feeStructureSelect) {
        feeStructureSelect.addEventListener('change', function() {
            if (transactionsField) {
                transactionsField.style.display = this.value === 'per_transaction' ? '' : 'none';
            }
            updateFees();
        });
    }

    if (estimatedTransactionsInput) {
        estimatedTransactionsInput.addEventListener('change', updateFees);
    }

    // Get selected services
    function getSelectedServices() {
        const services = [];
        for (const [checkboxId, serviceId] of Object.entries(serviceCheckboxes)) {
            const checkbox = document.getElementById(checkboxId);
            if (checkbox && checkbox.checked) {
                services.push(serviceId);
            }
        }
        return services;
    }

    // Format currency
    function formatCurrency(amount) {
        return '£' + amount.toLocaleString('en-GB');
    }

    // Parse currency string to number
    function parseCurrency(str) {
        return parseInt(String(str).replace(/[^0-9.-]/g, '')) || 0;
    }

    // Recalculate totals from editable cells
    function recalcTotals() {
        let totalFixed = 0;
        let totalTx = 0;
        document.querySelectorAll('#fee-table-body tr').forEach(row => {
            const feeTypeSelect = row.querySelector('.fee-type-select');
            const feeInput = row.querySelector('.fee-annual');
            const costPerTxInput = row.querySelector('.fee-cost-per-tx');
            const txPerYearInput = row.querySelector('.fee-tx-per-year');
            const totalTxCell = row.querySelector('.fee-total-tx');

            const feeType = feeTypeSelect ? feeTypeSelect.value : 'fixed';
            const annualFee = feeInput ? parseCurrency(feeInput.value) : 0;
            const costPerTx = costPerTxInput ? parseCurrency(costPerTxInput.value) : 0;
            const txPerYear = txPerYearInput ? parseCurrency(txPerYearInput.value) : 0;
            const rowTxFee = costPerTx * txPerYear;

            // Update Total TX Fee cell
            if (totalTxCell) {
                totalTxCell.textContent = rowTxFee > 0 ? formatCurrency(rowTxFee) : '-';
            }

            if (feeType === 'fixed') {
                totalFixed += annualFee;
            }
            totalTx += rowTxFee;
        });

        const totalApprox = totalFixed + totalTx;

        // Update footer totals
        const totalFixedEl = document.getElementById('total-fixed-fee');
        if (totalFixedEl) totalFixedEl.textContent = formatCurrency(totalFixed);

        const totalTxEl = document.getElementById('total-tx-fee');
        if (totalTxEl) totalTxEl.textContent = formatCurrency(totalTx);

        const annualTotal = document.getElementById('annual-total');
        if (annualTotal) annualTotal.textContent = formatCurrency(totalApprox);

        const sidebarAnnual = document.getElementById('sidebar-annual');
        if (sidebarAnnual) sidebarAnnual.textContent = formatCurrency(totalApprox);

        // Setup total
        let setupTotal = 0;
        document.querySelectorAll('#setup-table-body tr').forEach(row => {
            const input = row.querySelector('.setup-fee-input');
            if (input) {
                setupTotal += parseCurrency(input.value);
            } else {
                const td = row.querySelector('td:last-child');
                if (td) setupTotal += parseCurrency(td.textContent);
            }
        });
        const setupTotalEl = document.getElementById('setup-total');
        if (setupTotalEl) setupTotalEl.textContent = formatCurrency(setupTotal);

        const sidebarSetup = document.getElementById('sidebar-setup');
        if (sidebarSetup) sidebarSetup.textContent = formatCurrency(setupTotal);

        const sidebarYear1 = document.getElementById('sidebar-year1');
        if (sidebarYear1) sidebarYear1.textContent = formatCurrency(totalApprox + setupTotal);

        // Effective bps
        if (fundSize > 0) {
            const bps = (totalApprox / fundSize * 10000).toFixed(2);
            const effectiveBps = document.getElementById('effective-bps');
            if (effectiveBps) effectiveBps.textContent = bps + ' bps';
        }
    }

    // Render a fee row (editable)
    function renderFeeRow(service, isCustom, index) {
        const isTransaction = service.fee_type === 'transaction' || (service.per_unit && service.per_unit !== null);
        const feeTypeVal = isTransaction ? 'transaction' : 'fixed';
        const fee = service.adjusted_fee || 0;
        const costPerTx = service.cost_per_transaction || 0;
        const txPerYear = service.transactions_per_year || 0;
        const totalTxFee = costPerTx * txPerYear;

        const deleteBtn = isCustom ?
            `<button class="btn btn-sm btn-outline-danger" onclick="removeCustomRow(${index})" title="Remove"><i class="bi bi-x"></i></button>` :
            '';

        return `
            <tr data-custom="${isCustom}" data-index="${index}">
                <td>${isCustom ?
                    `<input type="text" class="form-control form-control-sm fee-name" value="${service.name}" style="min-width:120px;">` :
                    service.name}</td>
                <td>
                    <select class="form-select form-select-sm fee-type-select" onchange="window.recalcTotals()" style="width:130px;">
                        <option value="fixed" ${feeTypeVal === 'fixed' ? 'selected' : ''}>Fixed Fee</option>
                        <option value="transaction" ${feeTypeVal === 'transaction' ? 'selected' : ''}>Transaction</option>
                    </select>
                </td>
                <td class="text-end">
                    <input type="number" class="form-control form-control-sm text-end fee-annual" value="${fee}" style="width:110px;display:inline-block;" onchange="window.recalcTotals()">
                </td>
                <td class="text-end">
                    <input type="number" class="form-control form-control-sm text-end fee-cost-per-tx" value="${costPerTx}" style="width:100px;display:inline-block;" onchange="window.recalcTotals()">
                </td>
                <td class="text-end">
                    <input type="number" class="form-control form-control-sm text-end fee-tx-per-year" value="${txPerYear}" style="width:100px;display:inline-block;" onchange="window.recalcTotals()">
                </td>
                <td class="text-end fee-total-tx">${totalTxFee > 0 ? formatCurrency(totalTxFee) : '-'}</td>
                <td>${deleteBtn}</td>
            </tr>
        `;
    }

    // Update fee tables
    async function updateFees() {
        const services = getSelectedServices();

        try {
            const feeStructure = feeStructureSelect ? feeStructureSelect.value : 'fixed';
            const estimatedTransactions = estimatedTransactionsInput ? parseInt(estimatedTransactionsInput.value) || 100 : 100;

            const response = await fetch('/api/fees/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fund_size: fundSize,
                    services: services,
                    num_investors: numInvestors,
                    num_directors: numDirectors,
                    complexity: 'low',
                    include_setup: true,
                    fee_structure: feeStructure,
                    estimated_transactions: estimatedTransactions
                })
            });

            const result = await response.json();

            if (result.status === 'ok') {
                // Update service breakdown table with editable inputs
                const feeTableBody = document.getElementById('fee-table-body');
                if (feeTableBody) {
                    let html = '';
                    result.service_breakdown.forEach((service, i) => {
                        html += renderFeeRow(service, false, i);
                    });
                    // Add custom rows
                    customRows.forEach((cr, i) => {
                        html += renderFeeRow(cr, true, i);
                    });
                    feeTableBody.innerHTML = html;
                }

                // Update setup table (editable)
                const setupTableBody = document.getElementById('setup-table-body');
                if (setupTableBody) {
                    let html = '';
                    for (const setup of result.setup_breakdown) {
                        html += `
                            <tr>
                                <td>${setup.name}</td>
                                <td class="text-end">
                                    <input type="number" class="form-control form-control-sm text-end setup-fee-input" value="${setup.amount || 0}" style="width:110px;display:inline-block;" onchange="window.recalcTotals()">
                                </td>
                            </tr>
                        `;
                    }
                    setupTableBody.innerHTML = html;
                }

                // Recalculate all totals from the rendered inputs
                recalcTotals();
            }
        } catch (error) {
            console.error('Fee calculation error:', error);
        }
    }

    // Add custom service row
    window.addCustomService = function() {
        customRows.push({
            name: 'Custom Service',
            per_unit: null,
            adjusted_fee: 0,
            cost_per_transaction: 0,
            transactions_per_year: 0
        });
        updateFees();
    };

    // Remove custom row
    window.removeCustomRow = function(index) {
        customRows.splice(index, 1);
        updateFees();
    };

    // Expose recalcTotals globally for inline onchange
    window.recalcTotals = recalcTotals;

    // Collect fee table data as JSON
    function collectFeeData() {
        const feeRows = [];
        document.querySelectorAll('#fee-table-body tr').forEach(row => {
            const nameInput = row.querySelector('.fee-name');
            const name = nameInput ? nameInput.value : row.querySelector('td:first-child').textContent.trim();
            const feeTypeSelect = row.querySelector('.fee-type-select');
            feeRows.push({
                name: name,
                fee_type: feeTypeSelect ? feeTypeSelect.value : 'fixed',
                annual_fee: parseCurrency(row.querySelector('.fee-annual')?.value),
                cost_per_transaction: parseCurrency(row.querySelector('.fee-cost-per-tx')?.value),
                transactions_per_year: parseCurrency(row.querySelector('.fee-tx-per-year')?.value)
            });
        });
        const setupRows = [];
        document.querySelectorAll('#setup-table-body tr').forEach(row => {
            const name = row.querySelector('td:first-child')?.textContent.trim();
            const input = row.querySelector('.setup-fee-input');
            setupRows.push({
                name: name || '',
                amount: input ? parseCurrency(input.value) : 0
            });
        });
        return { fees: feeRows, setup: setupRows };
    }

    // Export Proposal - open admin agreement PDF
    document.getElementById('btn-export').addEventListener('click', function() {
        window.open('/api/onboarding/' + onboardingId + '/admin-agreement', '_blank');
    });

    // Save Draft
    document.getElementById('btn-save-draft').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Saving...';

        try {
            const feeData = collectFeeData();
            const services = getSelectedServices();

            const response = await fetch('/api/onboarding/' + onboardingId + '/save-fees', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    services: services,
                    fee_data: feeData,
                    fee_structure: feeStructureSelect ? feeStructureSelect.value : 'fixed',
                    estimated_transactions: estimatedTransactionsInput ? parseInt(estimatedTransactionsInput.value) || 100 : 100
                })
            });

            const result = await response.json();
            if (result.status === 'ok') {
                btn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Saved!';
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-success');
                setTimeout(() => {
                    btn.innerHTML = '<i class="bi bi-save me-1"></i> Save Draft';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                    btn.disabled = false;
                }, 2000);
            } else {
                alert('Save failed: ' + (result.message || 'Unknown error'));
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-save me-1"></i> Save Draft';
            }
        } catch (error) {
            console.error('Save draft error:', error);
            alert('Failed to save draft. Please try again.');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save me-1"></i> Save Draft';
        }
    });

    // Add service button
    document.getElementById('btn-add-service').addEventListener('click', function() {
        window.addCustomService();
    });

    // Bind change listeners to all service checkboxes
    for (const checkboxId of Object.keys(serviceCheckboxes)) {
        const checkbox = document.getElementById(checkboxId);
        if (checkbox) {
            checkbox.addEventListener('change', updateFees);
        }
    }

    // Initial calculation on page load
    updateFees();
});
</script>
{% endblock extra_js %}
